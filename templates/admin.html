<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>PCM Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-card {
            margin-inline-start: 30px;
            padding: 20px;

            background: #fff;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .08);
            width: 50%;
            max-height: 40vh;
            overflow: auto;
            transition: background 160ms ease, transform 160ms ease, box-shadow 160ms ease;
            will-change: transform;
        }

        .admin-card:hover {
            background: #fff;
            transform: translateY(-1px);
            /* same lift as .home-dashboard .card:hover */
            box-shadow: 0 14px 34px rgba(0, 0, 0, 0.10);
            /* same shadow depth */
        }

        .admin-card:active {
            transform: translateY(0);
        }

        .admin-card.expanded {
            max-height: 80vh;
        }

        .admin-head {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .admin-title {
            font-weight: 800;
            font-size: 1.05rem;
            color: #111827;
            margin: 0;
        }

        ._spacer {
            flex: 1 1 auto;
        }

        .size-toggle {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: .45rem .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background .2s ease;
        }

        .size-toggle:hover {
            background: #e5e7eb;
        }

        .req-list {
            display: grid;
            gap: 10px;
        }

        .req-row {
            display: flex;
            align-items: center;
            background: #fafafa;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            padding: 10px 12px;
            max-height: 50px;
        }

        .req-info {
            display: flex;
            gap: 16px;
        }

        .req-info span {
            font-size: .95rem;
            font-weight: 600;
            color: #111827;
        }

        .req-info .muted {
            color: #6b7280;
            font-weight: 500;
        }

        .req-actions {
            margin-left: auto;
            display: inline-flex;
            gap: 0;
        }

        /* Modern solid buttons */
        .btn {
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            font-weight: 600;
            font-size: .8rem;
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.25s ease, transform 0.15s ease, box-shadow 0.25s ease;
            line-height: 1.2;
        }

        /* Forest green */
        .btn-approve {
            background: #1b5e20;
        }

        .btn-approve:hover {
            background: #145214;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 94, 32, 0.35);
        }

        /* Darker red */
        .btn-deny {
            background: #8b0000;
        }

        .btn-deny:hover {
            background: #6e0000;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.35);
        }

        /* Pressed state */
        .btn:active {
            transform: translateY(0);
            box-shadow: none;
            filter: brightness(0.95);
        }

        /* Kill form defaults */
        .req-actions form {
            margin: 0;
            padding: 0;
            border: none;
            background: transparent;
            display: inline;
        }

        .empty {
            color: #6b7280;
            font-weight: 600;
            background: #fafafa;
            border: 1px dashed #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        /* ðŸ”¹ Blue variant â€” exact same shape/size/behavior as .btn-deny */
        .btn-admin {
            background: #878da0a2;
        }

        .btn-admin:hover {
            background: #878da0d1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.35);
        }

        .btn {
            white-space: nowrap;
            /* prevents wrapping */
            width: 100px;
            /* adjust this to match Delete button size */
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Sidebar (220px wide; CSS already handles styling) -->
    <div class="sidebar">
        <img src="/static/pcm-lockup-goldc-final.svg" alt="PCM logo" />

        <!-- Top navigation -->
        <div class="nav-top">
            <a href="/dashboard" class="{{ 'active' if section == 'home' else '' }}"><span>Home</span></a>
            <a href="/form" class="{{ 'active' if section == 'form' else '' }}"><span>Capturing Form</span></a>
            <a href="/dashboard/vodacom" class="{{ 'active' if section == 'vodacom' else '' }}"><span>Vodacom
                    Dashboard</span></a>
            <a href="/dashboard/devices" class="{{ 'active' if section == 'devices' else '' }}"><span>Devices
                    Dashboard</span></a>
        </div>

        <!-- Bottom navigation -->
        <div class="nav-bottom">
            {% if request.session.get('is_admin') %}
            <a href="/admin" class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            {% endif %}


            <a href="/settings" class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>
        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">âŸ¨</span> </button>
    </div>





    <!-- Left-aligned content space; not centered -->
    <div class="content" style="margin:20px var(--content-gap) 20px var(--sidebar-space);">
        <div id="adminCard" class="admin-card">
            <div class="admin-head">
                <h2 class="admin-title">Pending account requests</h2>
                <div class="_spacer"></div>
                <button class="size-toggle" type="button" onclick="toggleAdminCard()">Expand</button>
            </div>

            {% if not pending %}
            <div class="empty">No pending requests.</div>
            {% else %}
            <div class="req-list">
                {% for p in pending %}
                <div class="req-row">
                    <div class="req-info">
                        <span>{{ p.name }}</span>
                        <span>{{ p.surname }}</span>
                        <span class="muted">{{ p.email }}</span>
                    </div>

                    <div class="req-actions">
                        <form method="post" action="/admin/approve/{{ p.id }}">
                            <button class="btn btn-approve" type="submit">Approve</button>
                        </form>
                        <form method="post" action="/admin/deny/{{ p.id }}">
                            <button class="btn btn-deny" type="submit">Deny</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div id="adminUsersCard" class="admin-card">
            <div class="admin-head">
                <h2 class="admin-title">Active user accounts</h2>
                <div class="_spacer"></div>
                <button class="size-toggle" type="button" onclick="toggleCard('adminUsersCard', this)">Expand</button>
            </div>

            {% if not users %}
            <div class="empty">No active users.</div>
            {% else %}
            <div class="req-list">
                {% for u in users %}
                <div class="req-row">
                    <div class="req-info">
                        <span>{{ u.name or 'â€”' }}</span>
                        <span>{{ u.surname or 'â€”' }}</span>
                        <span class="muted">{{ u.email }}</span>

                        <!-- â¬‡ï¸ add a small role badge inline (keeps layout) -->
                        {% if u.is_admin %}
                        <span class="badge badge-admin">Admin</span>
                        {% else %}
                        <span class="badge badge-user">User</span>
                        {% endif %}
                    </div>

                    <div class="req-actions">
                        <!-- existing delete -->
                        <form method="post" action="/admin/users/delete/{{ u.id }}"
                            onsubmit="return confirm('Are you sure you want to delete this user?');"
                            style="display:inline;">
                            <button class="btn btn-deny" type="submit">Delete</button>
                        </form>

                        <!-- â¬‡ï¸ add make/revoke buttons inline (no new layout wrappers) -->
                        {% if not u.is_admin %}
                        <form method="post" action="/admin/users/{{ u.id }}/make-admin"
                            style="display:inline; margin-left:8px;">
                            <button class="btn btn-admin" type="submit">Make admin</button>
                        </form>
                        {% else %}
                        <form method="post" action="/admin/users/{{ u.id }}/revoke-admin"
                            style="display:inline; margin-left:8px;">
                            <button class="btn btn-admin" type="submit">Revoke admin</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>




    </div>


    <div class="content" style="margin:20px var(--content-gap) 20px var(--sidebar-space);">
        <div id="adminEditsCard" class="admin-card">
            <div class="admin-head">
                <h2 class="admin-title">Edit requests</h2>
                <div class="_spacer"></div>
                <button class="size-toggle" type="button" onclick="toggleCard('adminEditsCard', this)">Expand</button>
            </div>

            {% if not edit_requests %}
            <div class="empty">No edit requests.</div>
            {% else %}
            <div class="req-list">
                {% for r in edit_requests %}
                <div class="req-row">
                    <div class="req-info" style="gap:16px; flex-wrap:wrap">
                        <span class="muted">{{ r.requester_email }}</span>
                        {% if r.kind == 'contract' %}
                        <span>Contract #{{ r.ref_id }}</span>
                        {% else %}
                        <span>Device #{{ r.ref_id }}</span>
                        {% endif %}

                        {% if r.changes %}
                        <span class="muted">
                            {% set parts = [] %}
                            {% for k, v in r.changes.items() %}
                            {% set _ = parts.append(k ~ ' â†’ ' ~ v) %}
                            {% endfor %}
                            {{ parts|join(', ') }}
                        </span>
                        {% endif %}
                    </div>

                    <div class="req-actions">
                        {% if r.kind == 'contract' %}
                        <form method="post" action="/admin/contract-edit-requests/{{ r.id }}/approve">
                            <button class="btn btn-approve" type="submit">Approve</button>
                        </form>
                        <form method="post" action="/admin/contract-edit-requests/{{ r.id }}/deny">
                            <button class="btn btn-deny" type="submit">Deny</button>
                        </form>
                        {% else %}
                        <form method="post" action="/admin/edit-requests/{{ r.id }}/approve">
                            <button class="btn btn-approve" type="submit">Approve</button>
                        </form>
                        <form method="post" action="/admin/edit-requests/{{ r.id }}/deny">
                            <button class="btn btn-deny" type="submit">Deny</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <!-- Invisible spacer to maintain vertical rhythm -->
        <div class="admin-card" style="opacity:0; pointer-events:none; visibility:hidden;">
            <div class="admin-head">
                <h2 class="admin-title">Placeholder</h2>
            </div>
            <div class="empty">Spacer</div>
        </div>

    </div>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const handle = document.getElementById("sidebarHandle");
            const collapseBtn = document.getElementById("sidebarCollapse"); // optional header button
            const scrim = document.getElementById("sidebarScrim");

            function toggleSidebar() {
                const collapsed = document.body.classList.toggle("sidebar-collapsed");

                handle?.setAttribute("aria-pressed", String(!collapsed ? true : false));
                handle?.setAttribute(
                    "aria-label",
                    collapsed ? "Expand sidebar" : "Collapse sidebar"
                );
                handle.title = collapsed ? "Expand sidebar" : "Collapse sidebar";
            }

            handle?.addEventListener("click", toggleSidebar);
            collapseBtn?.addEventListener("click", toggleSidebar);

            scrim?.addEventListener("click", () => {
                document.body.classList.remove("sidebar-open");
            });
        });

        function toggleAdminCard() {
            const el = document.getElementById('adminCard');
            el.classList.toggle('expanded');
            const btn = document.querySelector('.size-toggle');
            btn.textContent = el.classList.contains('expanded') ? 'Shrink' : 'Expand';
        }
        document.addEventListener("DOMContentLoaded", () => {
            const logoutLink = document.getElementById("logoutLink");
            if (logoutLink) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault(); // stop direct navigation
                    const confirmed = confirm("Are you sure you want to log out?");
                    if (confirmed) {
                        window.location.href = this.href; // proceed to /logout
                    }
                });
            }
        });

        function toggleCard(id, btnEl) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle('expanded');
            if (btnEl) {
                btnEl.textContent = el.classList.contains('expanded') ? 'Shrink' : 'Expand';
            }
        }


        document.addEventListener("DOMContentLoaded", () => {
            /* â€¦ your existing sidebar JS â€¦ */

            // === NEW: play the active-link intro animation on page load (skip Log Out) ===
            const activeLinks = Array.from(document.querySelectorAll(".sidebar a.active"))
                .filter(a => a.id !== "logoutLink");

            // Start them in â€œhoverâ€ pose and animate into â€œactiveâ€
            activeLinks.forEach(a => a.classList.add("just-activated"));

            // After 1s (box-shadow fade done), clean up the temp class
            setTimeout(() => {
                activeLinks.forEach(a => a.classList.remove("just-activated"));
            }, 1050);
        });


    </script>

</body>

</html>