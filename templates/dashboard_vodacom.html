<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">

</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<body>
    <!-- Sidebar navigation -->
    <div class="sidebar">
        <a href="/" class="{{ 'active' if section == 'form' else '' }}"><span>Capturing Form</span></a>
        <a href="/dashboard" class="{{ 'active' if section == 'home' else '' }}"><span>Dashboard</span></a>
        <a href="/dashboard/vodacom" class="{{ 'active' if section == 'vodacom' else '' }}"><span>Vodacom
                Dashboard</span></a>
        <a href="/dashboard/devices" class="{{ 'active' if section == 'devices' else '' }}"><span>Devices
                Dashboard</span></a>
    </div>


    <!-- Main content -->
    <div class="content3">
        <div class="boxTopHeader2">Vodacom Contracts Dashboard</div>

    </div>
    <div class="sort-overlay">
        <label for="sortSelect">Sort by:</label>
        <select id="sort-select">
            <option value="">Latest Entry</option>
            <option value="inception_date">Inception Date</option>
            <option value="termination_date">Termination Date</option>
            <option value="monthly_costs">Monthly Costs</option>
        </select>
    </div>
    <div class="sort-overlay2"><label>Export:</label>
        <button id="export-btn" class="export-button">
            <img src="/static/excel-document.svg" alt="Excel" class="excel-icon">
        </button>
        <button id="export-pdf-btn">
            <img src="/static/download.svg" alt="PDF Icon" class="pdf-icon">

        </button>

    </div>
    <div class="content2">

        <div class="contentInner2 ">

            {% if records %}
            <div class="table-mask"></div>
            <table class="sticky">
                <thead>

                    <tr class="header-row">

                    <tr class="header-row">
                        <th data-col="0">
                            <div class="header-label">Inception Date</div><br>
                            <input type="text" class="header-filter" data-col="0" style="display:none;" />
                            <button class="filter-toggle" data-col="0" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="1">
                            <div class="header-label">Termination Date</div><br>
                            <input type="text" class="header-filter" data-col="1" style="display:none;" />
                            <button class="filter-toggle" data-col="1" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="2">
                            <div class="header-label">Devices</div><br>
                            <input type="text" class="header-filter" data-col="2" style="display:none;" />
                            <button class="filter-toggle" data-col="2" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="3">
                            <div class="header-label">Name</div><br>
                            <input type="text" class="header-filter" data-col="3" style="display:none;" />
                            <button class="filter-toggle" data-col="3" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="4">
                            <div class="header-label">Surname</div><br>
                            <input type="text" class="header-filter" data-col="4" style="display:none;" />
                            <button class="filter-toggle" data-col="4" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="5">
                            <div class="header-label">Monthly Costs</div><br>
                            <input type="text" class="header-filter" data-col="5" style="display:none;" />
                            <button class="filter-toggle" data-col="5" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="6">
                            <div class="header-label">VAT</div><br>
                            <input type="text" class="header-filter" data-col="6" style="display:none;" />
                            <button class="filter-toggle" data-col="6" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="7">
                            <div class="header-label">Monthly Cost(Excl.VAT)</div><br>
                            <input type="text" class="header-filter" data-col="7" style="display:none;" />
                            <button class="filter-toggle" data-col="7" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="8">
                            <div class="header-label">Contract Type</div><br>
                            <input type="text" class="header-filter" data-col="8" style="display:none;" />
                            <button class="filter-toggle" data-col="8" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="9">
                            <div class="header-label">Contract Term</div><br>
                            <input type="text" class="header-filter" data-col="9" style="display:none;" />
                            <button class="filter-toggle" data-col="9" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="10">
                            <div class="header-label">SIM Card Number</div><br>
                            <input type="text" class="header-filter" data-col="10" style="display:none;" />
                            <button class="filter-toggle" data-col="10" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="11">
                            <div class="header-label">Personnel Number</div><br>
                            <input type="text" class="header-filter" data-col="11" style="display:none;" />
                            <button class="filter-toggle" data-col="11" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="12">
                            <div class="header-label">Company</div><br>
                            <input type="text" class="header-filter" data-col="12" style="display:none;" />
                            <button class="filter-toggle" data-col="12" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="13">
                            <div class="header-label">Client Division</div><br>
                            <input type="text" class="header-filter" data-col="13" style="display:none;" />
                            <button class="filter-toggle" data-col="13" aria-label="Search"> ⌕ </button>
                        </th>
                    </tr>



                </thead>
                <tbody>
                    {% for sub in records %}
                    <tr>
                        <td>{{ sub.Inception_Date.strftime('%Y-%m-%d') if sub.Inception_Date else '' }}</td>
                        <td>{{ sub.Termination_Date.strftime('%Y-%m-%d') if sub.Termination_Date else '' }}</td>
                        <td>
                            {% if sub.devices and sub.devices | length > 0 %}
                            <button class="view-contracts-btn" onclick="showDevicesModal('{{ sub.id }}')">View
                                Devices</button>
                            {% else %}
                            No devices
                            {% endif %}
                        </td>
                        <td>{{ sub.Name_ }}</td>
                        <td>{{ sub.Surname_ }}</td>
                        <td>{{ sub.Monthly_Costs }}</td>
                        <td>{{ sub.VAT }}</td>
                        <td>{{ sub.Monthly_Cost_Excl_VAT }}</td>
                        <td>{{ sub.Contract_Type }}</td>
                        <td>{{ sub.Contract_Term }}</td>
                        <td>{{ sub.Sim_Card_Number }}</td>
                        <td>{{ sub.Personnel_nr }}</td>
                        <td>{{ sub.Company }}</td>
                        <td>{{ sub.Client_Division }}</td>
                    </tr>


                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No records found.</p>
            {% endif %}
        </div>
    </div>
    <div id="deviceModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeDevicesModal()">&times;</span>
            <h2>Linked Devices</h2>
            <div id="deviceModalBody">
                <!-- device list will go here -->
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            z-index: 999;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            margin: auto;
            width: 60%;
            border-radius: 6px;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const table = document.querySelector("table.sticky");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const filters = {};

            // === Filtering ===
            document.querySelectorAll(".filter-toggle").forEach(btn => {
                const col = btn.dataset.col;
                const th = btn.closest("th");
                const input = th.querySelector(".header-filter");

                btn.addEventListener("click", () => {
                    btn.style.display = "none";
                    input.style.display = "inline-block";
                    input.focus();
                });

                input.addEventListener("input", () => {
                    filters[col] = input.value.toLowerCase().trim();
                    applyFilters();
                });

                input.addEventListener("blur", () => {
                    if (!input.value.trim()) {
                        input.style.display = "none";
                        btn.style.display = "inline-block";
                    }
                });

                input.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        input.value = "";
                        filters[col] = "";
                        input.style.display = "none";
                        btn.style.display = "inline-block";
                        applyFilters();
                    }
                });
            });

            function applyFilters() {
                rows.forEach(row => {
                    let visible = true;
                    for (let col in filters) {
                        const val = filters[col];
                        const cellText = row.cells[col].textContent.toLowerCase().trim();
                        if (val && !cellText.includes(val)) {
                            visible = false;
                            break;
                        }
                    }
                    row.style.display = visible ? "" : "none";
                });
            }

            // === Sorting ===
            const sortSelect = document.getElementById("sort-select");

            if (sortSelect) {
                sortSelect.addEventListener("change", () => {
                    const sortBy = sortSelect.value;
                    const rowsArray = Array.from(tbody.querySelectorAll("tr"));

                    let colIndex;
                    let isDate = false;

                    switch (sortBy) {
                        case "inception_date":
                            colIndex = 0;
                            isDate = true;
                            break;
                        case "termination_date":
                            colIndex = 1;
                            isDate = true;
                            break;
                        case "monthly_costs":
                            colIndex = 5;
                            break;
                        default:
                            return;
                    }


                    rowsArray.sort((a, b) => {
                        let valA = a.cells[colIndex].textContent.trim();
                        let valB = b.cells[colIndex].textContent.trim();

                        if (isDate) {
                            valA = new Date(valA);
                            valB = new Date(valB);
                            return valA - valB;
                        } else {
                            valA = parseFloat(valA) || 0;
                            valB = parseFloat(valB) || 0;
                            return valB - valA;
                        }
                    });

                    // Re-insert sorted rows
                    while (tbody.firstChild) {
                        tbody.removeChild(tbody.firstChild);
                    }
                    rowsArray.forEach(row => tbody.appendChild(row));
                });
            }

            // === Export to CSV ===
            const exportBtn = document.getElementById("export-btn");

            if (exportBtn) {
                exportBtn.addEventListener("click", () => {
                    const rowsToExport = Array.from(table.querySelectorAll("tr"));
                    const csv = rowsToExport.map(row => {
                        const cols = row.querySelectorAll("td, th");
                        const rowData = Array.from(cols).map((col, index) => {
                            let text = col.textContent.trim();

                            // Prevent Excel from misinterpreting date columns
                            if (index === 10 || index === 11) {
                                text = `="${text}"`; // Force Excel to treat as text
                            }

                            // Escape double quotes
                            return `"${text.replace(/"/g, '""')}"`;
                        }).join(",");
                        return rowData;
                    }).join("\n");

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "vodacom_dashboard_export.csv";
                    a.style.display = "none";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }
        });
        document.addEventListener("DOMContentLoaded", () => {
            const pdfBtn = document.getElementById("export-pdf-btn");
            const table = document.querySelector("table.sticky");

            if (pdfBtn && table) {
                pdfBtn.addEventListener("click", () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape'); // Use landscape for wide tables

                    const headers = [];
                    const data = [];

                    // Extract table headers
                    const ths = table.querySelectorAll("thead th");
                    ths.forEach(th => {
                        const label = th.querySelector(".header-label");
                        headers.push(label ? label.textContent.trim() : th.textContent.trim());
                    });

                    // Extract table data
                    const rows = table.querySelectorAll("tbody tr");
                    rows.forEach(row => {
                        const rowData = [];
                        row.querySelectorAll("td").forEach((td, index) => {
                            let text = td.textContent.trim();

                            // Keep date formatting
                            if (index === 10 || index === 11) {
                                text = text;
                            }

                            rowData.push(text);
                        });
                        data.push(rowData);
                    });

                    doc.text("Vodacom Dashboard Export", 14, 15);
                    doc.autoTable({
                        head: [headers],
                        body: data,
                        startY: 20,
                        styles: { fontSize: 8, cellPadding: 2 }
                    });

                    doc.save("vodacom_dashboard_export.pdf");
                });
            }
        });
        function showDevicesModal(contractId) {
            fetch(`/contracts/${contractId}/devices`)
                .then(response => response.json())
                .then(data => {
                    const body = document.getElementById("deviceModalBody");
                    if (data.length === 0) {
                        body.innerHTML = "<p>No devices found.</p>";
                    } else {
                        body.innerHTML = `
                    <table border="1" width="100%" cellpadding="5">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Surname</th>
                                <th>Personnel #</th>
                                <th>Company</th>
                                <th>Client Division</th>
                                <th>Device Name</th>
                                <th>Serial Number</th>
                                <th>Description</th>
                                <th>Insurance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(device => `
                                <tr>
                                    <td>${device.Name_}</td>
                                    <td>${device.Surname_}</td>
                                    <td>${device.Personnel_nr}</td>
                                    <td>${device.Company}</td>
                                    <td>${device.Client_Division}</td>
                                    <td>${device.Device_Name}</td>
                                    <td>${device.Serial_Number}</td>
                                    <td>${device.Device_Description}</td>
                                    <td>${device.insurance}</td>
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>
                `;
                    }
                    document.getElementById("deviceModal").style.display = "block";
                });
        }

        function closeDevicesModal() {
            document.getElementById("deviceModal").style.display = "none";
        }
    </script>





</body>


</html>