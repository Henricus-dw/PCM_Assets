<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">
    <link rel="icon" href="/static/pcm-lockup-goldc-final.svg" type="image/svg+xml" />

</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<body>
    <!-- Sidebar navigation -->
    <div class="sidebar">

        <!-- Top navigation -->
        <div class="nav-top">
            <a href="/dashboard" class="{{ 'active' if section == 'home' else '' }}"><span>Home</span></a>
            <a href="/form" class="{{ 'active' if section == 'form' else '' }}"><span>Capturing Form</span></a>
            <a href="/dashboard/vodacom" class="{{ 'active' if section == 'vodacom' else '' }}"><span>Vodacom
                    Dashboard</span></a>
            <a href="/dashboard/devices" class="{{ 'active' if section == 'devices' else '' }}"><span>Devices
                    Dashboard</span></a>
        </div>
        <div class="sidebar-mid">
            <a href="/" class="sidebar-return" title="Return">↺ Return</a>
        </div>

        <!-- Bottom navigation -->
        <div class="nav-bottom">
            {% if request.session.get('is_admin') %}
            <a href="/admin" class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            {% endif %}


            <a href="/settings" class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>
        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">⟨</span> </button>
    </div>

    <!-- Main content -->
    <div class="content3">
        <div class="boxTopHeader2">Vodacom Contracts Dashboard</div>

    </div>
    <div class="sort-overlay">
        <label for="sortSelect">Sort by:</label>
        <select id="sort-select">
            <option value="">Latest Entry</option>
            <option value="inception_date">Inception Date</option>
            <option value="termination_date">Termination Date</option>
            <option value="monthly_costs">Monthly Costs</option>
        </select>
    </div>
    <div class="sort-overlay2"><label>Export:</label>
        <button id="export-btn" class="export-button">
            <img src="/static/excel-document.svg" alt="Excel" class="excel-icon">
        </button>
        <button id="export-pdf-btn">
            <img src="/static/download.svg" alt="PDF Icon" class="pdf-icon">

        </button>

    </div>
    <div class="content2">

        <div class="contentInner2 ">

            {% if records %}
            <div class="table-mask"></div>
            <table class="sticky">
                <thead>

                    <tr class="header-row">

                    <tr class="header-row">
                        <th data-col="0">
                            <div class="header-label">Inception Date</div><br>
                            <input type="text" class="header-filter" data-col="0" style="display:none;" />
                            <button class="filter-toggle" data-col="0" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="1">
                            <div class="header-label">Termination Date</div><br>
                            <input type="text" class="header-filter" data-col="1" style="display:none;" />
                            <button class="filter-toggle" data-col="1" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="2">
                            <div class="header-label">Devices</div><br>
                            <input type="text" class="header-filter" data-col="2" style="display:none;" />
                            <button class="filter-toggle" data-col="2" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="3">
                            <div class="header-label">Name</div><br>
                            <input type="text" class="header-filter" data-col="3" style="display:none;" />
                            <button class="filter-toggle" data-col="3" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="4">
                            <div class="header-label">Surname</div><br>
                            <input type="text" class="header-filter" data-col="4" style="display:none;" />
                            <button class="filter-toggle" data-col="4" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="5">
                            <div class="header-label">Monthly Costs</div><br>
                            <input type="text" class="header-filter" data-col="5" style="display:none;" />
                            <button class="filter-toggle" data-col="5" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="6">
                            <div class="header-label">VAT</div><br>
                            <input type="text" class="header-filter" data-col="6" style="display:none;" />
                            <button class="filter-toggle" data-col="6" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="7">
                            <div class="header-label">Monthly Cost(Excl.VAT)</div><br>
                            <input type="text" class="header-filter" data-col="7" style="display:none;" />
                            <button class="filter-toggle" data-col="7" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="8">
                            <div class="header-label">Contract Type</div><br>
                            <input type="text" class="header-filter" data-col="8" style="display:none;" />
                            <button class="filter-toggle" data-col="8" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="9">
                            <div class="header-label">Contract Term</div><br>
                            <input type="text" class="header-filter" data-col="9" style="display:none;" />
                            <button class="filter-toggle" data-col="9" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="10">
                            <div class="header-label">SIM Card Number</div><br>
                            <input type="text" class="header-filter" data-col="10" style="display:none;" />
                            <button class="filter-toggle" data-col="10" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="11">
                            <div class="header-label">Personnel Number</div><br>
                            <input type="text" class="header-filter" data-col="11" style="display:none;" />
                            <button class="filter-toggle" data-col="11" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="12">
                            <div class="header-label">Company</div><br>
                            <input type="text" class="header-filter" data-col="12" style="display:none;" />
                            <button class="filter-toggle" data-col="12" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="13">
                            <div class="header-label">Client Division</div><br>
                            <input type="text" class="header-filter" data-col="13" style="display:none;" />
                            <button class="filter-toggle" data-col="13" aria-label="Search"> ⌕ </button>
                        </th>
                    </tr>



                </thead>
                <tbody>
                    {% for sub in records %}
                    <tr data-contract-id="{{ sub.id }}">
                        <td>{{ sub.Inception_Date.strftime('%Y-%m-%d') if sub.Inception_Date else '' }}</td>
                        <td>{{ sub.Termination_Date.strftime('%Y-%m-%d') if sub.Termination_Date else '' }}</td>
                        <td>
                            {% if sub.devices and sub.devices | length > 0 %}
                            <button class="view-contracts-btn" onclick="showDevicesModal('{{ sub.id }}')">View
                                Devices</button>
                            {% else %}
                            No devices
                            {% endif %}
                        </td>
                        <td>{{ sub.Name_ }}</td>
                        <td>{{ sub.Surname_ }}</td>
                        <td>{{ sub.Monthly_Costs }}</td>
                        <td>{{ sub.VAT }}</td>
                        <td>{{ sub.Monthly_Cost_Excl_VAT }}</td>
                        <td>{{ sub.Contract_Type }}</td>
                        <td>{{ sub.Contract_Term }}</td>
                        <td>{{ sub.Sim_Card_Number }}</td>
                        <td>{{ sub.Personnel_nr }}</td>
                        <td>{{ sub.Company }}</td>
                        <td>{{ sub.Client_Division }}</td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
            {% else %}
            <p>No records found.</p>
            {% endif %}
        </div>
    </div>
    <div id="deviceModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeDevicesModal()">&times;</span>
            <h2>Linked Devices</h2>
            <div id="deviceModalBody">
                <!-- device list will go here -->
            </div>
        </div>
    </div>

    <div id="editRowModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:800px;">
            <span class="close" onclick="closeEditRowModal()">&times;</span>
            <h2>Edit Contract</h2>
            <div id="editRowBody"></div>
            <div id="editSubmitWrap" style="text-align:center; margin-top:16px; display:none;">
                <button id="submitChangesBtn" class="confirm">Submit Changes</button>
            </div>
        </div>
    </div>



    <style>
        .modal {
            position: fixed;
            z-index: 999;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            margin: auto;
            width: 60%;
            border-radius: 6px;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>


    <script>
        (() => {
            // Namespace to avoid globals
            const VodaDash = (window.VodaDash = window.VodaDash || {});

            // -----------------------------
            // Base refs & utilities
            // -----------------------------
            const table = document.querySelector("table.sticky");
            const tbody = table?.tBodies?.[0];
            const scroller = document.querySelector(".contentInner2") || window;

            if (!table || !tbody) return; // nothing to wire if table absent

            const norm = (s) => (s ?? "").toString().trim().toLowerCase();

            const headerIndex = (() => {
                const map = {};
                table.querySelectorAll("thead th").forEach((th, i) => {
                    const labelEl = th.querySelector(".header-label");
                    const label = (labelEl ? labelEl.textContent : th.textContent).trim().toLowerCase();
                    map[label] = i;
                });
                return map;
            })();

            // Single source of truth for editable fields and header mapping
            const FIELD_KEYS = [
                "Inception_Date", "Termination_Date", "Name_", "Surname_",
                "Monthly_Costs", "VAT", "Monthly_Cost_Excl_VAT",
                "Contract_Type", "Contract_Term", "Sim_Card_Number",
                "Personnel_nr", "Company", "Client_Division", "due_upgrade"
            ];

            const keyToHeader = {
                Inception_Date: ["inception date"],
                Termination_Date: ["termination date"],
                Name_: ["name"],
                Surname_: ["surname"],
                Monthly_Costs: ["monthly costs", "monthly cost"],
                VAT: ["vat"],
                Monthly_Cost_Excl_VAT: ["monthly cost(excl.vat)", "monthly cost (excl.vat)"],
                Contract_Type: ["contract type"],
                Contract_Term: ["contract term"],
                Sim_Card_Number: ["sim card number", "sim"],
                Personnel_nr: ["personnel nr", "personnel number", "personnel #"],
                Company: ["company"],
                Client_Division: ["client division"],
                due_upgrade: ["due upgrade", "upgrade"]
            };

            const colIndexFor = (key) => {
                const labels = keyToHeader[key] || [];
                for (const l of labels) {
                    const idx = headerIndex[norm(l)];
                    if (idx != null) return idx;
                }
                return null;
            };

            // Cache original order for "Latest Entry"
            Array.from(tbody.rows).forEach((tr, i) => (tr.dataset.origIndex = String(i)));

            // Some tables include a "View Devices" button column (index 2); exclude from exports
            const VIEW_DEVICES_COL_INDEX = 2;

            // -----------------------------
            // Header filters
            // -----------------------------
            (function bindHeaderFilters() {
                const toggles = document.querySelectorAll(".filter-toggle");
                if (!toggles.length) return;

                const filters = {};
                const applyFilters = () => {
                    Array.from(tbody.rows).forEach((row) => {
                        let visible = true;
                        for (const col in filters) {
                            const val = filters[col];
                            if (!val) continue;
                            const cellText = (row.cells[col]?.textContent || "").toLowerCase().trim();
                            if (!cellText.includes(val)) {
                                visible = false;
                                break;
                            }
                        }
                        row.style.display = visible ? "" : "none";
                    });
                };

                document.querySelectorAll(".filter-toggle").forEach((btn) => {
                    const col = btn.dataset.col;
                    const th = btn.closest("th");
                    const input = th?.querySelector(".header-filter");
                    if (!input) return;

                    btn.addEventListener("click", () => {
                        btn.style.display = "none";
                        input.style.display = "inline-block";
                        input.focus();
                    });

                    input.addEventListener("input", () => {
                        filters[col] = input.value.toLowerCase().trim();
                        applyFilters();
                    });

                    input.addEventListener("blur", () => {
                        if (!input.value.trim()) {
                            input.style.display = "none";
                            btn.style.display = "inline-block";
                        }
                    });

                    input.addEventListener("keydown", (e) => {
                        if (e.key === "Escape") {
                            input.value = "";
                            filters[col] = "";
                            input.style.display = "none";
                            btn.style.display = "inline-block";
                            applyFilters();
                        }
                    });
                });
            })();

            // -----------------------------
            // Sorting (dropdown #sort-select)
            // -----------------------------
            (function bindSort() {
                const sortSelect = document.getElementById("sort-select");
                if (!sortSelect) return;

                const map = {
                    inception_date: ["inception date"],
                    termination_date: ["termination date"],
                    monthly_costs: ["monthly costs", "monthly cost", "monthly cost(excl.vat)"]
                };

                function resolveColumn(labels) {
                    for (const l of labels) {
                        const idx = headerIndex[norm(l)];
                        if (idx != null) return idx;
                    }
                    return null;
                }

                function sortRows(byKey) {
                    const rows = Array.from(tbody.rows);

                    if (!byKey) {
                        rows.sort((a, b) => +a.dataset.origIndex - +b.dataset.origIndex);
                        rows.forEach((r) => tbody.appendChild(r));
                        return;
                    }

                    const labels = map[byKey] || [];
                    const colIndex = resolveColumn(labels);
                    if (colIndex == null) return;

                    const isDate = byKey === "inception_date" || byKey === "termination_date";

                    rows.sort((a, b) => {
                        const A = (a.cells[colIndex]?.textContent || "").trim();
                        const B = (b.cells[colIndex]?.textContent || "").trim();

                        if (isDate) {
                            const dA = new Date(A);
                            const dB = new Date(B);
                            return dA - dB;
                        }

                        const nA = parseFloat(A.replace(/[^\d.-]/g, ""));
                        const nB = parseFloat(B.replace(/[^\d.-]/g, ""));
                        if (!isNaN(nA) && !isNaN(nB)) return nA - nB;

                        return A.localeCompare(B, undefined, { numeric: true, sensitivity: "base" });
                    });

                    rows.forEach((r) => tbody.appendChild(r));
                }

                sortSelect.addEventListener("change", (e) => sortRows(e.target.value));
            })();

            // -----------------------------
            // CSV export (supports new #export-csv-btn and legacy #export-btn)
            // -----------------------------
            (function bindCsvExports() {
                const btnAll = document.getElementById("export-csv-btn"); // exports all rows
                const btnVisible = document.getElementById("export-btn"); // exports visible rows (after filters)

                const buildCsv = (respectFilter) => {
                    // headers
                    const headers = Array.from(table.querySelectorAll("thead th"))
                        .map((th) => {
                            const label = th.querySelector(".header-label");
                            return (label ? label.textContent : th.textContent).trim();
                        })
                        .filter((_, i) => i !== VIEW_DEVICES_COL_INDEX)
                        .map((t) => `"${t.replace(/"/g, '""')}"`)
                        .join(",");

                    // rows
                    const rowSelector = respectFilter
                        ? Array.from(tbody.querySelectorAll("tr")).filter((tr) => tr.style.display !== "none")
                        : Array.from(tbody.querySelectorAll("tr"));

                    const body = rowSelector
                        .map((tr) => {
                            const cols = Array.from(tr.querySelectorAll("td"))
                                .filter((_, i) => i !== VIEW_DEVICES_COL_INDEX)
                                .map((td) => `"${(td.textContent || "").trim().replace(/"/g, '""')}"`)
                                .join(",");
                            return cols;
                        })
                        .join("\n");

                    return headers + "\n" + body;
                };

                function download(filename, text, mime = "text/plain;charset=utf-8;") {
                    const blob = new Blob([text], { type: mime });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                }

                if (btnAll) {
                    btnAll.addEventListener("click", () => {
                        download("vodacom_dashboard_export.csv", buildCsv(false), "text/csv;charset=utf-8;");
                    });
                }
                if (btnVisible) {
                    btnVisible.addEventListener("click", () => {
                        download("vodacom_dashboard_export.csv", buildCsv(true), "text/csv;charset=utf-8;");
                    });
                }
            })();

            // -----------------------------
            // PDF export (#export-pdf-btn) using jsPDF + autoTable
            // -----------------------------
            (function bindPdfExport() {
                const btn = document.getElementById("export-pdf-btn");
                if (!btn) return;

                btn.addEventListener("click", () => {
                    const jspdfNS = window.jspdf;
                    const jsPDF = jspdfNS && jspdfNS.jsPDF;
                    if (!jsPDF || typeof jsPDF !== "function") {
                        alert("PDF library not loaded. Check jsPDF script tag.");
                        return;
                    }
                    if (!("autoTable" in (jsPDF.API || {}))) {
                        alert("autoTable plugin not loaded. Check the autoTable script tag.");
                        return;
                    }

                    const headers = Array.from(table.querySelectorAll("thead th"))
                        .map((th) => {
                            const label = th.querySelector(".header-label");
                            return (label ? label.textContent : th.textContent).trim();
                        })
                        .filter((_, i) => i !== VIEW_DEVICES_COL_INDEX);

                    const body = [];
                    table.querySelectorAll("tbody tr").forEach((tr) => {
                        const row = Array.from(tr.querySelectorAll("td"))
                            .filter((_, i) => i !== VIEW_DEVICES_COL_INDEX)
                            .map((td) => td.textContent.trim());
                        body.push(row);
                    });

                    const doc = new jsPDF("landscape");
                    doc.text("Vodacom Dashboard Export", 14, 15);
                    doc.autoTable({
                        head: [headers],
                        body,
                        startY: 20,
                        styles: { fontSize: 8, cellPadding: 2 }
                    });
                    doc.save("vodacom_dashboard_export.pdf");
                });
            })();

            // -----------------------------
            // Floating "three dots" rail + Edit modal (queue request)
            // -----------------------------
            (function bindRowEditUI() {
                const modal = document.getElementById("editRowModal");
                const modalBody = document.getElementById("editRowBody");
                const submitWrap = document.getElementById("editSubmitWrap");
                const submitBtn = document.getElementById("submitChangesBtn");
                if (!modal || !modalBody || !submitWrap || !submitBtn) return;

                // Floating rail
                const rail = document.createElement("div");
                rail.className = "editbtn-rail";
                Object.assign(rail.style, {
                    position: "fixed",
                    width: "30px",
                    height: "0px",
                    left: "-9999px",
                    top: "-9999px",
                    pointerEvents: "none",
                    zIndex: "999999"
                });

                const editBtn = document.createElement("button");
                editBtn.type = "button";
                editBtn.className = "editbtn";
                editBtn.innerHTML = `
      <div class="editbtn__dots">
        <span class="editbtn__dot"></span>
        <span class="editbtn__dot"></span>
        <span class="editbtn__dot"></span>
      </div>`;
                Object.assign(editBtn.style, {
                    position: "absolute",
                    left: "0",
                    top: "0",
                    width: "30px",
                    height: "0px",
                    display: "none",
                    pointerEvents: "auto"
                });

                rail.appendChild(editBtn);
                document.body.appendChild(rail);

                let hideTimer = null;
                let activeRow = null;
                let currentContractId = null;
                let pending = {};

                function positionRail() {
                    const clipR = scroller === window
                        ? document.documentElement.getBoundingClientRect()
                        : scroller.getBoundingClientRect();
                    rail.style.left = clipR.left - 30 + "px";
                    rail.style.top = clipR.top + "px";
                    rail.style.height = clipR.height + "px";
                }

                function positionBtnForRow(row) {
                    const rowR = row.getBoundingClientRect();
                    const clipR = scroller === window
                        ? document.documentElement.getBoundingClientRect()
                        : scroller.getBoundingClientRect();
                    editBtn.style.top = rowR.top - clipR.top + "px";
                    editBtn.style.height = rowR.height + "px";
                }

                function showForRow(row) {
                    clearTimeout(hideTimer);
                    activeRow = row;
                    currentContractId = row.getAttribute("data-contract-id") || null;
                    positionRail();
                    positionBtnForRow(row);
                    editBtn.style.display = "flex";
                    editBtn.classList.remove("editbtn--visible");
                    requestAnimationFrame(() => editBtn.classList.add("editbtn--visible"));
                }

                function hideIfAllowed() {
                    if (!activeRow) return;
                    const overRow = activeRow.matches(":hover");
                    const overBtn = editBtn.matches(":hover");
                    if (!overRow && !overBtn) {
                        editBtn.style.display = "none";
                        editBtn.classList.remove("editbtn--visible");
                    }
                }

                function relayout() {
                    if (activeRow) {
                        positionRail();
                        positionBtnForRow(activeRow);
                    } else {
                        positionRail();
                    }
                }

                Array.from(tbody.rows).forEach((row) => {
                    row.addEventListener("pointerenter", () => showForRow(row));
                    row.addEventListener("pointerleave", (e) => {
                        if (e.relatedTarget && (e.relatedTarget === editBtn || editBtn.contains(e.relatedTarget))) return;
                        clearTimeout(hideTimer);
                        hideTimer = setTimeout(hideIfAllowed, 140);
                    });
                });

                editBtn.addEventListener("pointerenter", () => clearTimeout(hideTimer));
                editBtn.addEventListener("pointerleave", (e) => {
                    if (activeRow && e.relatedTarget && (e.relatedTarget === activeRow || activeRow.contains(e.relatedTarget))) return;
                    clearTimeout(hideTimer);
                    hideTimer = setTimeout(hideIfAllowed, 100);
                });

                (scroller === window ? window : scroller).addEventListener("scroll", relayout, { passive: true });
                window.addEventListener("resize", relayout);
                relayout();

                // Modal controls
                function openModal() { modal.style.display = "block"; }
                function closeModal() { modal.style.display = "none"; }
                window.closeEditRowModal = closeModal; // keep existing API

                function snapshotRecord(tr) {
                    const rec = {};
                    FIELD_KEYS.forEach((key) => {
                        const ci = colIndexFor(key);
                        if (ci != null && tr.cells[ci]) rec[key] = tr.cells[ci].textContent.trim();
                    });
                    return rec;
                }

                function buildEditGrid(record) {
                    const tableEl = document.createElement("table");
                    tableEl.className = "editgrid";
                    tableEl.innerHTML = `
        <thead>
          <tr>
            <th>Field</th>
            <th>Current Value</th>
            <th></th>
            <th>New Value</th>
          </tr>
        </thead>
        <tbody></tbody>`;
                    const tBody = tableEl.querySelector("tbody");

                    FIELD_KEYS.forEach((key) => {
                        const label = key.replace(/_/g, " ");
                        const cur = (record[key] ?? "").toString();
                        const isNumber = ["Monthly_Costs", "VAT", "Monthly_Cost_Excl_VAT"].includes(key);
                        const typeAttr = /date/i.test(key) ? 'type="date"' : (isNumber ? 'type="number" step="0.01"' : 'type="text"');

                        const rowEl = document.createElement("tr");
                        rowEl.innerHTML = `
          <td class="field-col">${label}</td>
          <td class="value-col"><div class="pill">${cur}</div></td>
          <td class="edit-col">
            <button type="button" class="confirm edit-row-btn" data-key="${key}">Edit</button>
          </td>
          <td class="new-col">
            <div class="pill edit-input-wrap" data-key="${key}" style="display:none;">
              <input ${typeAttr} class="edit-input" value="">
            </div>
          </td>`;
                        tBody.appendChild(rowEl);
                    });

                    return tableEl;
                }

                function openEditModalFromRow(tr) {
                    currentContractId = tr.getAttribute("data-contract-id") || currentContractId;
                    if (!currentContractId) return;

                    const record = snapshotRecord(tr);
                    const grid = buildEditGrid(record);

                    modalBody.innerHTML = "";
                    modalBody.appendChild(grid);
                    submitWrap.style.display = "none";
                    pending = {};
                    openModal();

                    if (!modalBody._delegationBound) {
                        modalBody._delegationBound = true;
                        modalBody.addEventListener("click", (e) => {
                            const btn = e.target.closest(".edit-row-btn");
                            if (!btn) return;
                            const key = btn.dataset.key;
                            const wrap = modalBody.querySelector(`.edit-input-wrap[data-key="${key}"]`);
                            if (!wrap) return;

                            wrap.style.display = "flex";
                            const input = wrap.querySelector(".edit-input");
                            input.value = (record[key] ?? "");
                            input.focus();

                            if (!input._bound) {
                                input._bound = true;
                                input.addEventListener("input", () => {
                                    const before = (record[key] ?? "").toString();
                                    const after = input.value;
                                    if (after !== before) pending[key] = after;
                                    else delete pending[key];
                                    submitWrap.style.display = Object.keys(pending).length ? "block" : "none";
                                });
                            }
                        });
                    }
                }

                editBtn.addEventListener("click", () => {
                    if (!activeRow) {
                        alert("No active row found");
                        return;
                    }
                    currentContractId = activeRow.getAttribute("data-contract-id");
                    if (!currentContractId) {
                        alert("No contract ID on this row");
                        return;
                    }
                    openEditModalFromRow(activeRow);
                });

                submitBtn.addEventListener("click", async () => {
                    if (!currentContractId) {
                        alert("No contract ID.");
                        closeModal();
                        return;
                    }
                    if (!Object.keys(pending).length) {
                        alert("No changes to submit.");
                        closeModal();
                        return;
                    }

                    submitBtn.disabled = true;
                    try {
                        const resp = await fetch(`/api/contracts/${currentContractId}/edit-requests`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(pending)
                        });
                        if (!resp.ok) throw new Error("Failed to queue edit request");
                        const res = await resp.json();
                        if (res.created || res.queued) {
                            alert("Edit request submitted for approval.");
                            closeModal();
                        } else {
                            alert(res.message || "Could not queue request.");
                        }
                    } catch (err) {
                        alert(err?.message || "Failed to queue edit request.");
                    } finally {
                        submitBtn.disabled = false;
                    }
                });

                // Close on backdrop click
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) closeModal();
                });
            })();

            // -----------------------------
            // Devices modal (global funcs for existing onclicks)
            // -----------------------------
            (function exposeDevicesModal() {
                window.showDevicesModal = function showDevicesModal(contractId) {
                    fetch(`/contracts/${contractId}/devices`)
                        .then((r) => r.json())
                        .then((data) => {
                            const body = document.getElementById("deviceModalBody");
                            if (!Array.isArray(data) || data.length === 0) {
                                body.innerHTML = "<p>No devices found.</p>";
                            } else {
                                body.innerHTML = `
              <table border="1" width="100%" cellpadding="5">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Surname</th>
                    <th>Personnel #</th>
                    <th>Company</th>
                    <th>Client Division</th>
                    <th>Device Name</th>
                    <th>Serial Number</th>
                    <th>Description</th>
                    <th>Insurance</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.map(d => `
                    <tr>
                      <td>${d.Name_ ?? ""}</td>
                      <td>${d.Surname_ ?? ""}</td>
                      <td>${d.Personnel_nr ?? ""}</td>
                      <td>${d.Company ?? ""}</td>
                      <td>${d.Client_Division ?? ""}</td>
                      <td>${d.Device_Name ?? ""}</td>
                      <td>${d.Serial_Number ?? ""}</td>
                      <td>${d.Device_Description ?? ""}</td>
                      <td>${d.insurance ?? ""}</td>
                    </tr>
                  `).join("")}
                </tbody>
              </table>`;
                            }
                            document.getElementById("deviceModal").style.display = "block";
                        })
                        .catch(() => {
                            document.getElementById("deviceModalBody").innerHTML = "<p>Failed to load devices.</p>";
                            document.getElementById("deviceModal").style.display = "block";
                        });
                };

                window.closeDevicesModal = function closeDevicesModal() {
                    const modal = document.getElementById("deviceModal");
                    if (modal) modal.style.display = "none";
                };
            })();

            // -----------------------------
            // Sidebar handle + scrim + link kick-back
            // -----------------------------
            (function bindSidebar() {
                const handle = document.getElementById("sidebarHandle");
                const collapseBtn = document.getElementById("sidebarCollapse");
                const scrim = document.getElementById("sidebarScrim");

                function toggleSidebar() {
                    const collapsed = document.body.classList.toggle("sidebar-collapsed");
                    handle?.setAttribute("aria-pressed", String(!collapsed ? true : false));
                    handle?.setAttribute("aria-label", collapsed ? "Expand sidebar" : "Collapse sidebar");
                    if (collapsed) document.body.classList.remove("sidebar-open");
                }

                handle?.addEventListener("click", toggleSidebar);
                collapseBtn?.addEventListener("click", toggleSidebar);
                scrim?.addEventListener("click", () => document.body.classList.remove("sidebar-open"));

                const activeLinks = Array.from(document.querySelectorAll(".sidebar a.active")).filter(
                    (a) => a.id !== "logoutLink"
                );
                activeLinks.forEach((a) => a.classList.add("just-activated"));
                setTimeout(() => activeLinks.forEach((a) => a.classList.remove("just-activated")), 1050);
            })();
        })();
    </script>




</body>


</html>