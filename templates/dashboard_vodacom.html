<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">

</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<body>
    <!-- Sidebar navigation -->
    <div class="sidebar">
        <img src="/static/pcm-lockup-goldc-final.svg" alt="PCM logo" />

        <!-- Top navigation -->
        <div class="nav-top">
            <a href="/dashboard" class="{{ 'active' if section == 'home' else '' }}"><span>Home</span></a>
            <a href="/form" class="{{ 'active' if section == 'form' else '' }}"><span>Capturing Form</span></a>
            <a href="/dashboard/vodacom" class="{{ 'active' if section == 'vodacom' else '' }}"><span>Vodacom
                    Dashboard</span></a>
            <a href="/dashboard/devices" class="{{ 'active' if section == 'devices' else '' }}"><span>Devices
                    Dashboard</span></a>
        </div>

        <!-- Bottom navigation -->
        <div class="nav-bottom">
            <a href="/admin" class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            <a href="/settings" class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>
        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">⟨</span> </button>
    </div>

    <!-- Main content -->
    <div class="content3">
        <div class="boxTopHeader2">Vodacom Contracts Dashboard</div>

    </div>
    <div class="sort-overlay">
        <label for="sortSelect">Sort by:</label>
        <select id="sort-select">
            <option value="">Latest Entry</option>
            <option value="inception_date">Inception Date</option>
            <option value="termination_date">Termination Date</option>
            <option value="monthly_costs">Monthly Costs</option>
        </select>
    </div>
    <div class="sort-overlay2"><label>Export:</label>
        <button id="export-btn" class="export-button">
            <img src="/static/excel-document.svg" alt="Excel" class="excel-icon">
        </button>
        <button id="export-pdf-btn">
            <img src="/static/download.svg" alt="PDF Icon" class="pdf-icon">

        </button>

    </div>
    <div class="content2">

        <div class="contentInner2 ">

            {% if records %}
            <div class="table-mask"></div>
            <table class="sticky">
                <thead>

                    <tr class="header-row">

                    <tr class="header-row">
                        <th data-col="0">
                            <div class="header-label">Inception Date</div><br>
                            <input type="text" class="header-filter" data-col="0" style="display:none;" />
                            <button class="filter-toggle" data-col="0" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="1">
                            <div class="header-label">Termination Date</div><br>
                            <input type="text" class="header-filter" data-col="1" style="display:none;" />
                            <button class="filter-toggle" data-col="1" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="2">
                            <div class="header-label">Devices</div><br>
                            <input type="text" class="header-filter" data-col="2" style="display:none;" />
                            <button class="filter-toggle" data-col="2" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="3">
                            <div class="header-label">Name</div><br>
                            <input type="text" class="header-filter" data-col="3" style="display:none;" />
                            <button class="filter-toggle" data-col="3" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="4">
                            <div class="header-label">Surname</div><br>
                            <input type="text" class="header-filter" data-col="4" style="display:none;" />
                            <button class="filter-toggle" data-col="4" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="5">
                            <div class="header-label">Monthly Costs</div><br>
                            <input type="text" class="header-filter" data-col="5" style="display:none;" />
                            <button class="filter-toggle" data-col="5" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="6">
                            <div class="header-label">VAT</div><br>
                            <input type="text" class="header-filter" data-col="6" style="display:none;" />
                            <button class="filter-toggle" data-col="6" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="7">
                            <div class="header-label">Monthly Cost(Excl.VAT)</div><br>
                            <input type="text" class="header-filter" data-col="7" style="display:none;" />
                            <button class="filter-toggle" data-col="7" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="8">
                            <div class="header-label">Contract Type</div><br>
                            <input type="text" class="header-filter" data-col="8" style="display:none;" />
                            <button class="filter-toggle" data-col="8" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="9">
                            <div class="header-label">Contract Term</div><br>
                            <input type="text" class="header-filter" data-col="9" style="display:none;" />
                            <button class="filter-toggle" data-col="9" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="10">
                            <div class="header-label">SIM Card Number</div><br>
                            <input type="text" class="header-filter" data-col="10" style="display:none;" />
                            <button class="filter-toggle" data-col="10" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="11">
                            <div class="header-label">Personnel Number</div><br>
                            <input type="text" class="header-filter" data-col="11" style="display:none;" />
                            <button class="filter-toggle" data-col="11" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="12">
                            <div class="header-label">Company</div><br>
                            <input type="text" class="header-filter" data-col="12" style="display:none;" />
                            <button class="filter-toggle" data-col="12" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="13">
                            <div class="header-label">Client Division</div><br>
                            <input type="text" class="header-filter" data-col="13" style="display:none;" />
                            <button class="filter-toggle" data-col="13" aria-label="Search"> ⌕ </button>
                        </th>
                    </tr>



                </thead>
                <tbody>
                    {% for sub in records %}
                    <tr data-contract-id="{{ sub.id }}">
                        <td>{{ sub.Inception_Date.strftime('%Y-%m-%d') if sub.Inception_Date else '' }}</td>
                        <td>{{ sub.Termination_Date.strftime('%Y-%m-%d') if sub.Termination_Date else '' }}</td>
                        <td>
                            {% if sub.devices and sub.devices | length > 0 %}
                            <button class="view-contracts-btn" onclick="showDevicesModal('{{ sub.id }}')">View
                                Devices</button>
                            {% else %}
                            No devices
                            {% endif %}
                        </td>
                        <td>{{ sub.Name_ }}</td>
                        <td>{{ sub.Surname_ }}</td>
                        <td>{{ sub.Monthly_Costs }}</td>
                        <td>{{ sub.VAT }}</td>
                        <td>{{ sub.Monthly_Cost_Excl_VAT }}</td>
                        <td>{{ sub.Contract_Type }}</td>
                        <td>{{ sub.Contract_Term }}</td>
                        <td>{{ sub.Sim_Card_Number }}</td>
                        <td>{{ sub.Personnel_nr }}</td>
                        <td>{{ sub.Company }}</td>
                        <td>{{ sub.Client_Division }}</td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
            {% else %}
            <p>No records found.</p>
            {% endif %}
        </div>
    </div>
    <div id="deviceModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeDevicesModal()">&times;</span>
            <h2>Linked Devices</h2>
            <div id="deviceModalBody">
                <!-- device list will go here -->
            </div>
        </div>
    </div>

    <div id="editRowModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:800px;">
            <span class="close" onclick="closeEditRowModal()">&times;</span>
            <h2>Edit Contract</h2>
            <div id="editRowBody"></div>
            <div id="editSubmitWrap" style="text-align:center; margin-top:16px; display:none;">
                <button id="submitChangesBtn" class="confirm">Submit Changes</button>
            </div>
        </div>
    </div>



    <style>
        .modal {
            position: fixed;
            z-index: 999;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            margin: auto;
            width: 60%;
            border-radius: 6px;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>


    <script>
        const keyToHeader = {
            Name_: ["name"],
            Surname_: ["surname"],
            Personnel_nr: ["personnel", "personnel #", "personnel nr"],
            Company: ["company"],
            Client_Division: ["client division"],
            Contract_Type: ["contract type"],
            Monthly_Costs: ["monthly costs", "monthly cost"],
            VAT: ["vat"],
            Monthly_Cost_Excl_VAT: ["monthly cost(excl.vat)", "cost (excl. vat)"],
            Contract_Term: ["contract term", "term"],
            Inception_Date: ["inception date"],
            Termination_Date: ["termination date"],
            Sim_Card_Number: ["sim card number", "sim"],
            due_upgrade: ["due upgrade", "upgrade"]
        };

        const FIELD_KEYS = [
            "Name_", "Surname_", "Personnel_nr", "Company", "Client_Division",
            "Contract_Type", "Monthly_Costs", "VAT", "Monthly_Cost_Excl_VAT",
            "Contract_Term", "Inception_Date", "Termination_Date", "Sim_Card_Number",
            "due_upgrade"
        ];
        document.addEventListener("DOMContentLoaded", () => {
            // ------------------------------------
            // Base refs
            // ------------------------------------
            const table = document.querySelector("table.sticky");
            if (!table) return;
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.querySelectorAll("tr"));

            // Optional scroller (your layout uses .contentInner2)
            const scroller = document.querySelector(".contentInner2") || window;

            // ------------------------------------
            // Header filters (works if you have .filter-toggle + .header-filter)
            // ------------------------------------
            (function bindHeaderFilters() {
                const filters = {};
                const toggles = document.querySelectorAll(".filter-toggle");
                if (!toggles.length) return;

                function applyFilters() {
                    rows.forEach(row => {
                        let visible = true;
                        for (const col in filters) {
                            const val = filters[col];
                            if (!val) continue;
                            const cellText = (row.cells[col]?.textContent || "").toLowerCase().trim();
                            if (!cellText.includes(val)) { visible = false; break; }
                        }
                        row.style.display = visible ? "" : "none";
                    });
                }

                document.querySelectorAll(".filter-toggle").forEach(btn => {
                    const col = btn.dataset.col;
                    const th = btn.closest("th");
                    const input = th?.querySelector(".header-filter");
                    if (!input) return;

                    btn.addEventListener("click", () => {
                        btn.style.display = "none";
                        input.style.display = "inline-block";
                        input.focus();
                    });

                    input.addEventListener("input", () => {
                        filters[col] = input.value.toLowerCase().trim();
                        applyFilters();
                    });

                    input.addEventListener("blur", () => {
                        if (!input.value.trim()) {
                            input.style.display = "none";
                            btn.style.display = "inline-block";
                        }
                    });

                    input.addEventListener("keydown", (e) => {
                        if (e.key === "Escape") {
                            input.value = "";
                            filters[col] = "";
                            input.style.display = "none";
                            btn.style.display = "inline-block";
                            applyFilters();
                        }
                    });
                });
            })();

            // ------------------------------------
            // CSV / PDF export (kept here so buttons still work)
            // ------------------------------------
            (function bindExports() {
                const csvBtn = document.getElementById("export-csv-btn");
                const pdfBtn = document.getElementById("export-pdf-btn");

                if (csvBtn && table) {
                    csvBtn.addEventListener("click", () => {
                        const headCells = Array.from(table.querySelectorAll("thead th"));
                        const headerRow = headCells.map(th => {
                            const label = th.querySelector(".header-label");
                            return (label ? label.textContent : th.textContent).trim();
                        }).map(text => `"${text.replace(/"/g, '""')}"`).join(",");

                        const bodyRows = Array.from(table.querySelectorAll("tbody tr")).map(tr => {
                            const cols = Array.from(tr.querySelectorAll("td")).map(td => {
                                const text = (td.textContent || "").trim();
                                return `"${text.replace(/"/g, '""')}"`;
                            }).join(",");
                            return cols;
                        }).join("\n");

                        const csv = headerRow + "\n" + bodyRows;
                        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = "vodacom_dashboard_export.csv";
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });
                }

                if (pdfBtn && table && window.jspdf?.jsPDF && window.jspdf?.autoTable) {
                    pdfBtn.addEventListener("click", () => {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF("landscape");
                        const headers = [];
                        const data = [];

                        table.querySelectorAll("thead th").forEach(th => {
                            const label = th.querySelector(".header-label");
                            headers.push(label ? label.textContent.trim() : th.textContent.trim());
                        });
                        table.querySelectorAll("tbody tr").forEach(tr => {
                            const row = [];
                            tr.querySelectorAll("td").forEach(td => row.push((td.textContent || "").trim()));
                            data.push(row);
                        });

                        doc.text("Vodacom Dashboard Export", 14, 15);
                        doc.autoTable({ head: [headers], body: data, startY: 20, styles: { fontSize: 8, cellPadding: 2 } });
                        doc.save("vodacom_dashboard_export.pdf");
                    });
                }
            })();

            // ------------------------------------
            // Map header text -> column index (for modal prefill)
            // ------------------------------------
            const headerIndex = (() => {
                const map = {};
                const ths = table.querySelectorAll("thead th");
                ths.forEach((th, i) => {
                    const labelEl = th.querySelector(".header-label");
                    const label = (labelEl ? labelEl.textContent : th.textContent).trim().toLowerCase();
                    map[label] = i;
                });
                return map;
            })();

            // Columns allowed for editing (must match backend allow-list)
            const FIELD_KEYS = [
                "Inception_Date", "Termination_Date", "Name_", "Surname_",
                "Monthly_Costs", "VAT", "Monthly_Cost_Excl_VAT",
                "Contract_Type", "Contract_Term", "Sim_Card_Number",
                "Personnel_nr", "Company", "Client_Division", "due_upgrade"
            ];

            const keyToHeader = {
                Inception_Date: ["inception date"],
                Termination_Date: ["termination date"],
                Name_: ["name"],
                Surname_: ["surname"],
                Monthly_Costs: ["monthly costs"],
                VAT: ["vat"],
                Monthly_Cost_Excl_VAT: ["monthly cost(excl.vat)", "monthly cost (excl.vat)"],
                Contract_Type: ["contract type"],
                Contract_Term: ["contract term"],
                Sim_Card_Number: ["sim card number"],
                Personnel_nr: ["personnel number"],
                Company: ["company"],
                Client_Division: ["client division"],
                due_upgrade: ["due upgrade"]
            };

            const norm = (s) => (s || "").toString().trim().toLowerCase();
            const colIndexFor = (key) => {
                const labels = keyToHeader[key] || [];
                for (const l of labels) {
                    const idx = headerIndex[norm(l)];
                    if (idx != null) return idx;
                }
                return null;
            };

            // ------------------------------------
            // Floating "three dots" rail (mirrors Devices)
            // ------------------------------------
            const rail = document.createElement("div");
            rail.className = "editbtn-rail";
            document.body.appendChild(rail);
            Object.assign(rail.style, {
                position: "fixed",
                width: "30px",
                height: "0px",
                left: "-9999px",
                top: "-9999px",
                pointerEvents: "none",
                zIndex: "999999"
            });

            const editBtn = document.createElement("button");
            editBtn.className = "editbtn";
            editBtn.type = "button";
            editBtn.innerHTML = `
    <div class="editbtn__dots">
      <span class="editbtn__dot"></span>
      <span class="editbtn__dot"></span>
      <span class="editbtn__dot"></span>
    </div>`;
            rail.appendChild(editBtn);
            Object.assign(editBtn.style, {
                position: "absolute",
                left: "0",
                top: "0",
                width: "30px",
                height: "0px",
                display: "none",
                pointerEvents: "auto"
            });



            let hideTimer = null;
            let activeRowForBtn = null;
            let currentContractId = null;
            function positionRailForCell() {
                const clipR = (scroller === window)
                    ? document.documentElement.getBoundingClientRect()
                    : scroller.getBoundingClientRect();
                rail.style.left = (clipR.left - 30) + "px";
                rail.style.top = clipR.top + "px";
                rail.style.height = clipR.height + "px";
            }

            function positionButtonForRow(row) {
                const rowR = row.getBoundingClientRect();
                const clipR = (scroller === window)
                    ? document.documentElement.getBoundingClientRect()
                    : scroller.getBoundingClientRect();
                editBtn.style.top = (rowR.top - clipR.top) + "px";
                editBtn.style.height = rowR.height + "px";
            }

            function showForRow(row) {
                clearTimeout(hideTimer);
                activeRowForBtn = row;
                currentContractId = row.getAttribute("data-contract-id") || null;
                positionRailForCell();
                positionButtonForRow(row);
                editBtn.style.display = "flex";
                editBtn.classList.remove("editbtn--visible");
                requestAnimationFrame(() => editBtn.classList.add("editbtn--visible"));
            }

            function hideIfAllowed() {
                if (!activeRowForBtn) return;
                const overRow = activeRowForBtn.matches(":hover");
                const overBtn = editBtn.matches(":hover");
                if (!overRow && !overBtn) {
                    editBtn.style.display = "none";
                    editBtn.classList.remove("editbtn--visible");


                }
            }

            function relayoutRail() {
                if (activeRowForBtn) {
                    positionRailForCell();
                    positionButtonForRow(activeRowForBtn);
                } else {
                    positionRailForCell();
                }
            }

            rows.forEach(row => {
                row.addEventListener("pointerenter", () => showForRow(row));
                row.addEventListener("pointerleave", (e) => {
                    if (e.relatedTarget && (e.relatedTarget === editBtn || editBtn.contains(e.relatedTarget))) return;
                    clearTimeout(hideTimer);
                    hideTimer = setTimeout(hideIfAllowed, 140);
                });
            });
            editBtn.addEventListener("pointerenter", () => clearTimeout(hideTimer));
            editBtn.addEventListener("pointerleave", (e) => {
                if (activeRowForBtn && e.relatedTarget && (e.relatedTarget === activeRowForBtn || activeRowForBtn.contains(e.relatedTarget))) return;
                clearTimeout(hideTimer);
                hideTimer = setTimeout(hideIfAllowed, 100);
            });
            (scroller === window ? window : scroller).addEventListener("scroll", relayoutRail, { passive: true });
            window.addEventListener("resize", relayoutRail);
            relayoutRail();

            // ------------------------------------
            // Edit Contract modal + queue request  (Devices-style UI + logic)
            // ------------------------------------
            // Use the actual Vodacom modal IDs
            const modal = document.getElementById("editRowModal");
            const modalBody = document.getElementById("editRowBody");
            const submitWrap = document.getElementById("editSubmitWrap");
            const submitBtn = document.getElementById("submitChangesBtn");


            function showEditModal() { if (modal) modal.style.display = "block"; }
            function closeEditModal() { if (modal) modal.style.display = "none"; }
            window.closeEditRowModal = closeEditModal;


            let pending = {}; // <-- declare ONCE here

            function openEditModalFromRow(tr) {
                currentContractId = tr.getAttribute("data-contract-id") || currentContractId;
                if (!modal || !modalBody || !submitWrap) return;


                // snapshot current values
                const record = {};
                FIELD_KEYS.forEach(key => {
                    const ci = colIndexFor(key);
                    if (ci != null && tr.cells[ci]) record[key] = tr.cells[ci].textContent.trim();
                });

                // build Devices-style 4-col grid
                const editTable = document.createElement("table");
                editTable.className = "editgrid";
                editTable.innerHTML = `
      <thead>
        <tr>
          <th>Field</th>
          <th>Current Value</th>
          <th></th>
          <th>New Value</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
                const tBody = editTable.querySelector("tbody");

                FIELD_KEYS.forEach((key) => {
                    const label = key.replace(/_/g, " ");
                    const cur = (record[key] ?? "").toString();
                    const isNumber = ["Monthly_Costs", "VAT", "Monthly_Cost_Excl_VAT"].includes(key);
                    const typeAttr = /date/i.test(key) ? 'type="date"' : (isNumber ? 'type="number" step="0.01"' : 'type="text"');

                    const rowEl = document.createElement("tr");
                    rowEl.innerHTML = `
        <td class="field-col">${label}</td>
        <td class="value-col"><div class="pill">${cur}</div></td>
        <td class="edit-col">
          <button type="button" class="confirm edit-row-btn" data-key="${key}">Edit</button>
        </td>
        <td class="new-col">
          <div class="pill edit-input-wrap" data-key="${key}" style="display:none;">
            <input ${typeAttr} class="edit-input" value="">
          </div>
        </td>
      `;
                    tBody.appendChild(rowEl);
                });

                modalBody.innerHTML = "";
                modalBody.appendChild(editTable);
                submitWrap.style.display = "none";
                pending = {};
                showEditModal();

                // delegated interaction
                if (!modalBody._delegationBound) {
                    modalBody._delegationBound = true;
                    modalBody.addEventListener("click", (e) => {
                        const btn = e.target.closest(".edit-row-btn");
                        if (!btn) return;
                        const key = btn.dataset.key;
                        const wrap = modalBody.querySelector(`.edit-input-wrap[data-key="${key}"]`);
                        if (!wrap) return;

                        wrap.style.display = "flex";
                        const input = wrap.querySelector(".edit-input");
                        input.value = (record[key] ?? "");
                        input.focus();

                        if (!input._bound) {
                            input._bound = true;
                            input.addEventListener("input", () => {
                                const before = (record[key] ?? "").toString();
                                const after = input.value;
                                if (after !== before) pending[key] = after;
                                else delete pending[key];
                                submitWrap.style.display = Object.keys(pending).length ? "block" : "none";
                            });
                        }
                    });
                }
            }

            // open modal from floating button
            editBtn.addEventListener("click", () => {
                if (!activeRowForBtn) {
                    alert("No active row found");
                    return;
                }

                currentContractId = activeRowForBtn.getAttribute("data-contract-id");
                console.log("✅ Locked contract ID at click:", currentContractId);

                if (!currentContractId) {
                    alert("No contract ID on this row");
                    return;
                }

                openEditModalFromRow(activeRowForBtn);
            });





            // submit → queue for approval
            if (submitBtn) {
                submitBtn.addEventListener("click", async () => {
                    if (!currentContractId) {
                        alert("No contract ID.");
                        closeEditModal();
                        return;
                    }

                    if (!currentContractId || !Object.keys(pending).length) {
                        alert("No contract ID or no changes.");
                        closeEditModal();
                        return;
                    }

                    submitBtn.disabled = true;
                    try {
                        const resp = await fetch(`/api/contracts/${currentContractId}/edit-requests`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(pending)
                        });
                        if (!resp.ok) throw new Error("Failed to queue edit request");
                        const res = await resp.json();
                        if (res.created || res.queued) {
                            alert("Edit request submitted for approval.");
                            closeEditModal();
                        } else {
                            alert(res.message || "Could not queue request.");
                        }
                    } catch (err) {
                        alert(err?.message || "Failed to queue edit request.");
                    } finally {
                        submitBtn.disabled = false;
                    }
                });
            }

            // close on backdrop click
            modal?.addEventListener("click", (e) => { if (e.target === modal) closeEditModal(); });

            // ------------------------------------
            // Optional: sidebar handle + scrim (safe no-ops if missing)
            // ------------------------------------
            const handle = document.getElementById("sidebarHandle");
            const collapseBtn = document.getElementById("sidebarCollapse");
            const scrim = document.getElementById("sidebarScrim");
            function toggleSidebar() {
                const collapsed = document.body.classList.toggle("sidebar-collapsed");
                handle?.setAttribute("aria-pressed", String(!collapsed ? true : false));
                handle?.setAttribute("aria-label", collapsed ? "Expand sidebar" : "Collapse sidebar");
                if (collapsed) document.body.classList.remove("sidebar-open");
            }
            handle?.addEventListener("click", toggleSidebar);
            collapseBtn?.addEventListener("click", toggleSidebar);
            scrim?.addEventListener("click", () => document.body.classList.remove("sidebar-open"));

            // Export to PDF (mirrors Devices) — keeping this here too
            const pdfBtn2 = document.getElementById("export-pdf-btn");
            if (pdfBtn2 && table && window.jspdf?.jsPDF && window.jspdf?.autoTable) {
                pdfBtn2.addEventListener("click", () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape');

                    const headers = [];
                    const data = [];

                    const ths = table.querySelectorAll("thead th");
                    ths.forEach(th => {
                        const label = th.querySelector(".header-label");
                        headers.push(label ? label.textContent.trim() : th.textContent.trim());
                    });

                    const trs = table.querySelectorAll("tbody tr");
                    trs.forEach(row => {
                        const rowData = [];
                        row.querySelectorAll("td").forEach((td) => {
                            let text = td.textContent.trim();
                            rowData.push(text);
                        });
                        data.push(rowData);
                    });

                    doc.text("Vodacom Dashboard Export", 14, 15);
                    doc.autoTable({ head: [headers], body: data, startY: 20, styles: { fontSize: 8, cellPadding: 2 } });
                    doc.save("vodacom_dashboard_export.pdf");
                });
            }
        });


    </script>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const table = document.querySelector("table.sticky");
            const tbody = table?.tBodies?.[0];
            const sortSelect = document.getElementById("sort-select");
            if (!table || !tbody || !sortSelect) return;

            // Map header label -> column index (lowercased, trimmed)
            const headerIndex = (() => {
                const map = {};
                const ths = table.querySelectorAll("thead th");
                ths.forEach((th, i) => {
                    const labelEl = th.querySelector(".header-label");
                    const label = (labelEl ? labelEl.textContent : th.textContent).trim().toLowerCase();
                    map[label] = i;
                });
                return map;
            })();

            // Capture original row order to restore "Latest Entry"
            Array.from(tbody.rows).forEach((tr, i) => tr.dataset.origIndex = String(i));

            function sortRows(byKey) {
                const rows = Array.from(tbody.rows);

                if (!byKey) {
                    // Restore original order
                    rows.sort((a, b) => (+a.dataset.origIndex) - (+b.dataset.origIndex));
                    rows.forEach(r => tbody.appendChild(r));
                    return;
                }

                // Match your dropdown values to header text
                const keyToHeader = {
                    "inception_date": ["inception date"],
                    "termination_date": ["termination date"],
                    "monthly_costs": ["monthly costs", "monthly cost", "monthly cost(excl.vat)"] // last entry is a fallback
                };

                // Guess column index from header text list
                const labels = keyToHeader[byKey] || [];
                let colIndex = null;
                for (const l of labels) {
                    const idx = headerIndex[l];
                    if (idx != null) { colIndex = idx; break; }
                }
                if (colIndex == null) return;

                const isDate = (byKey === "inception_date" || byKey === "termination_date");

                rows.sort((a, b) => {
                    const A = (a.cells[colIndex]?.textContent || "").trim();
                    const B = (b.cells[colIndex]?.textContent || "").trim();

                    if (isDate) {
                        const dA = new Date(A);
                        const dB = new Date(B);
                        return dA - dB;
                    }
                    // numeric if both parse to numbers, else text
                    const nA = parseFloat(A.replace(/[^\d.-]/g, ""));
                    const nB = parseFloat(B.replace(/[^\d.-]/g, ""));
                    if (!isNaN(nA) && !isNaN(nB)) return nA - nB;
                    return A.localeCompare(B, undefined, { numeric: true, sensitivity: "base" });
                });

                rows.forEach(r => tbody.appendChild(r));
            }

            sortSelect.addEventListener("change", (e) => {
                const val = e.target.value; // "", "inception_date", "termination_date", "monthly_costs"
                sortRows(val);
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const table = document.querySelector("table.sticky");
            const tbody = table?.tBodies?.[0];
            const csvBtn = document.getElementById("export-btn");
            if (!table || !tbody || !csvBtn) return;

            csvBtn.addEventListener("click", () => {
                // Build header row
                const headers = Array.from(table.querySelectorAll("thead th")).map(th => {
                    const label = th.querySelector(".header-label");
                    const text = (label ? label.textContent : th.textContent).trim();
                    return `"${text.replace(/"/g, '""')}"`;
                }).join(",");

                // Body rows (only rows not hidden by filtering)
                const body = Array.from(tbody.querySelectorAll("tr"))
                    .filter(tr => tr.style.display !== "none")
                    .map(tr => {
                        const cols = Array.from(tr.querySelectorAll("td")).map(td => {
                            const text = (td.textContent || "").trim();
                            return `"${text.replace(/"/g, '""')}"`;
                        }).join(",");
                        return cols;
                    }).join("\n");

                const csv = headers + "\n" + body;
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "vodacom_dashboard_export.csv";
                a.style.display = "none";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        });
    </script>




</body>


</html>