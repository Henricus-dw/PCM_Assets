<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">
    <link rel="icon" href="/static/pcm-lockup-goldc-final.svg" type="image/svg+xml" />

</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<body>
    <div class="sidebar">

        <!-- Top navigation -->
        <div class="nav-top">
            <a href="/dashboard" class="{{ 'active' if section == 'home' else '' }}"><span>Home</span></a>
            <a href="/form" class="{{ 'active' if section == 'form' else '' }}"><span>Capturing Form</span></a>

            <a href="/dashboard/vodacom" class="{{ 'active' if section == 'vodacom' else '' }}"><span>Vodacom
                    Dashboard</span></a>
            <a href="/dashboard/devices" class="{{ 'active' if section == 'devices' else '' }}"><span>Devices
                    Dashboard</span></a>
        </div>
        <div class="sidebar-mid">
            <a href="/" class="sidebar-return" title="Return">↺ Return</a>
        </div>

        <!-- Bottom navigation -->
        <!-- Bottom navigation -->
        <div class="nav-bottom">
            {% if request.session.get('is_admin') %}
            <a href="/admin" class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            {% endif %}


            <a href="/settings" class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>

        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">⟨</span> </button>
    </div>


    <!-- Main content -->
    <div class="content3">

        <div class="boxTopHeader2">Devices Dashboard</div>

    </div>
    <div class="sort-overlay">
        <label for="sortSelect">Sort by:</label>
        <select id="sort-select">
            <option value="">Latest Entry</option>
            <option value="inception_date">Inception Date</option>
            <option value="termination_date">Termination Date</option>
            <option value="monthly_costs">Monthly Costs</option>
        </select>
    </div>
    <div class="sort-overlay2"><label>Export:</label>
        <button id="export-btn" class="export-button">
            <img src="/static/excel-document.svg" alt="Excel" class="excel-icon">
        </button>
        <button id="export-pdf-btn">
            <img src="/static/download.svg" alt="PDF Icon" class="pdf-icon">

        </button>

    </div>
    <div class="content2">
        <div class="contentInner2">
            {% if devices %}
            <div class="table-mask"></div>
            <table class="sticky">
                <thead>
                    <tr class="header-row">
                        <th data-col="0">
                            <div class="header-label">Name</div><br>
                            <input type="text" class="header-filter" data-col="0" style="display:none;" />
                            <button class="filter-toggle" data-col="0" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="1">
                            <div class="header-label">Surname</div><br>
                            <input type="text" class="header-filter" data-col="1" style="display:none;" />
                            <button class="filter-toggle" data-col="1" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="2">
                            <div class="header-label">Personnel Number</div><br>
                            <input type="text" class="header-filter" data-col="2" style="display:none;" />
                            <button class="filter-toggle" data-col="2" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="3">
                            <div class="header-label">Company</div><br>
                            <input type="text" class="header-filter" data-col="3" style="display:none;" />
                            <button class="filter-toggle" data-col="3" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="4">
                            <div class="header-label">Client Division</div><br>
                            <input type="text" class="header-filter" data-col="4" style="display:none;" />
                            <button class="filter-toggle" data-col="4" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="5">
                            <div class="header-label">Vodacom Contract</div><br>
                            <input type="text" class="header-filter" data-col="5" style="display:none;" />
                            <button class="filter-toggle" data-col="5" aria-label="Search">⌕</button>
                        </th>

                        <th data-col="6">
                            <div class="header-label">Device Name</div><br>
                            <input type="text" class="header-filter" data-col="6" style="display:none;" />
                            <button class="filter-toggle" data-col="6" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="7">
                            <div class="header-label">Serial Number</div><br>
                            <input type="text" class="header-filter" data-col="7" style="display:none;" />
                            <button class="filter-toggle" data-col="7" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="8">
                            <div class="header-label">Description</div><br>
                            <input type="text" class="header-filter" data-col="8" style="display:none;" />
                            <button class="filter-toggle" data-col="8" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="9">
                            <div class="header-label">Insurance</div><br>
                            <input type="text" class="header-filter" data-col="9" style="display:none;" />
                            <button class="filter-toggle" data-col="9" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="10">
                            <div class="header-label">Past Device Owners</div><br>
                            <input type="text" class="header-filter" data-col="10" style="display:none;" />
                            <button class="filter-toggle" data-col="10" aria-label="Search"> ⌕ </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr data-device-id="{{ device.id }}">
                        <td>{{ device.Name_ }}</td>
                        <td>{{ device.Surname_ }}</td>
                        <td>{{ device.Personnel_nr }}</td>
                        <td>{{ device.Company }}</td>
                        <td>{{ device.Client_Division }}</td>
                        <td>
                            {% if device.vd_id %}
                            <button class="view-contracts-btn" onclick="showContractsModal('{{ device.id }}')">View
                                Contracts</button>
                            {% else %}
                            No contract linked to this device
                            {% endif %}
                        </td>

                        <td>{{ device.Device_Name }}</td>
                        <td>{{ device.Serial_Number }}</td>
                        <td>{{ device.Device_Description }}</td>
                        <td>{{ device.insurance }}</td>
                        <td>
                            {% if device.past_owners_display %}
                            {{ device.past_owners_display.replace('\n', '<br>') | safe }}
                            {% else %}
                            No past owners
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No devices found.</p>
            {% endif %}
        </div>


    </div>
    <div id="deviceModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeDevicesModal()">&times;</span>
            <h2>Linked Devices</h2>
            <div id="deviceModalBody">
                <!-- device list will go here -->
            </div>
        </div>
    </div>
    <div id="editRowModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:800px;">
            <span class="close" onclick="closeEditRowModal()">&times;</span>
            <h2>Edit Device</h2>
            <div id="editRowBody"></div>
            <div id="editSubmitWrap" style="text-align:center; margin-top:16px; display:none;">
                <button id="submitChangesBtn" class="confirm">Submit Changes</button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            z-index: 999;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            margin: auto;
            width: 60%;
            border-radius: 6px;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // ------------------------------------
            // Restore scroll + highlight after a save/reload
            // ------------------------------------
            try {
                const saved = JSON.parse(sessionStorage.getItem("devices_restore") || "null");
                if (saved) {
                    const container = document.querySelector(".contentInner2");
                    if (saved.scroll?.type === "element" && container) {
                        container.scrollTop = saved.scroll.top || 0;
                        container.scrollLeft = saved.scroll.left || 0;
                    } else {
                        window.scrollTo(saved.scroll?.left || 0, saved.scroll?.top || 0);
                    }
                    if (saved.highlightId) {
                        const r = document.querySelector(
                            `table.sticky tbody tr[data-device-id="${saved.highlightId}"]`
                        );
                        if (r) {
                            r.classList.add("just-updated");
                            setTimeout(() => r.classList.remove("just-updated"), 2400);
                        }
                    }
                    sessionStorage.removeItem("devices_restore");
                }
            } catch (_) { }

            // ------------------------------------
            // Base table refs
            // ------------------------------------
            const table = document.querySelector("table.sticky");
            if (!table) return;
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.querySelectorAll("tr"));

            // ------------------------------------
            // Filtering (header search toggles)
            // ------------------------------------
            const filters = {};
            document.querySelectorAll(".filter-toggle").forEach(btn => {
                const col = btn.dataset.col;
                const th = btn.closest("th");
                const input = th.querySelector(".header-filter");

                btn.addEventListener("click", () => {
                    btn.style.display = "none";
                    input.style.display = "inline-block";
                    input.focus();
                });

                input.addEventListener("input", () => {
                    filters[col] = input.value.toLowerCase().trim();
                    applyFilters();
                });

                input.addEventListener("blur", () => {
                    if (!input.value.trim()) {
                        input.style.display = "none";
                        btn.style.display = "inline-block";
                    }
                });

                input.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        input.value = "";
                        filters[col] = "";
                        input.style.display = "none";
                        btn.style.display = "inline-block";
                        applyFilters();
                    }
                });
            });

            function applyFilters() {
                rows.forEach(row => {
                    let visible = true;
                    for (let col in filters) {
                        const val = filters[col];
                        const cellText = row.cells[col].textContent.toLowerCase().trim();
                        if (val && !cellText.includes(val)) {
                            visible = false;
                            break;
                        }
                    }
                    row.style.display = visible ? "" : "none";
                });
            }

            // ------------------------------------
            // Sorting (kept as in your original; no-op unless you use those headers)
            // ------------------------------------
            const sortSelect = document.getElementById("sort-select");
            if (sortSelect) {
                sortSelect.addEventListener("change", () => {
                    const sortBy = sortSelect.value;
                    const rowsArray = Array.from(tbody.querySelectorAll("tr"));
                    let colIndex;
                    let isDate = false;

                    switch (sortBy) {
                        case "inception_date": colIndex = 0; isDate = true; break;
                        case "termination_date": colIndex = 1; isDate = true; break;
                        case "monthly_costs": colIndex = 5; break;
                        default: return;
                    }

                    rowsArray.sort((a, b) => {
                        let valA = a.cells[colIndex].textContent.trim();
                        let valB = b.cells[colIndex].textContent.trim();
                        if (isDate) {
                            return new Date(valA) - new Date(valB);
                        } else {
                            return (parseFloat(valB) || 0) - (parseFloat(valA) || 0);
                        }
                    });

                    tbody.innerHTML = "";
                    rowsArray.forEach(row => tbody.appendChild(row));
                });
            }

            // ------------------------------------
            // Export to CSV (original behavior)
            // ------------------------------------
            const exportBtn = document.getElementById("export-btn");
            if (exportBtn) {
                exportBtn.addEventListener("click", () => {
                    const rowsToExport = Array.from(table.querySelectorAll("tr"));
                    const csv = rowsToExport.map(row => {
                        const cols = row.querySelectorAll("td, th");
                        const rowData = Array.from(cols).map((col, index) => {
                            let text = col.textContent.trim();
                            if (index === 10 || index === 11) text = `="${text}"`; // keep Excel from parsing
                            return `"${text.replace(/"/g, '""')}"`;
                        }).join(",");
                        return rowData;
                    }).join("\n");

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "Devices_dashboard_export.csv"; // original name
                    a.style.display = "none";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }

            // ------------------------------------
            // Export to PDF (original behavior)
            // ------------------------------------
            const pdfBtn = document.getElementById("export-pdf-btn");
            if (pdfBtn && table) {
                pdfBtn.addEventListener("click", () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape');

                    const headers = [];
                    const data = [];
                    const ths = table.querySelectorAll("thead th");
                    ths.forEach(th => {
                        const label = th.querySelector(".header-label");
                        headers.push(label ? label.textContent.trim() : th.textContent.trim());
                    });
                    const trs = table.querySelectorAll("tbody tr");
                    trs.forEach(row => {
                        const rowData = [];
                        row.querySelectorAll("td").forEach((td, index) => {
                            let text = td.textContent.trim();
                            rowData.push(text);
                        });
                        data.push(rowData);
                    });

                    doc.text("Vodacom Dashboard Export", 14, 15);
                    doc.autoTable({
                        head: [headers],
                        body: data,
                        startY: 20,
                        styles: { fontSize: 8, cellPadding: 2 }
                    });
                    doc.save("Devices_Dashboard_export.pdf");
                });
            }

            // ------------------------------------
            // View Contracts modal (original behavior)
            // ------------------------------------
            window.showContractsModal = function (deviceId) {
                fetch(`/devices/${deviceId}/contract`)
                    .then(res => res.json())
                    .then(contract => {
                        const body = document.getElementById("deviceModalBody");
                        if (!contract || Object.keys(contract).length === 0) {
                            body.innerHTML = "<p>No contract linked to this device.</p>";
                        } else {
                            body.innerHTML = `
            <table border="1" width="100%" cellpadding="5">
              <thead>
                <tr>
                  <th>Name</th><th>Surname</th><th>Personnel #</th><th>Company</th>
                  <th>Client Division</th><th>Contract Type</th><th>Monthly Costs</th>
                  <th>VAT</th><th>Cost (Excl. VAT)</th><th>Term</th>
                  <th>Inception</th><th>Termination</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${contract.Name_}</td>
                  <td>${contract.Surname_}</td>
                  <td>${contract.Personnel_nr}</td>
                  <td>${contract.Company}</td>
                  <td>${contract.Client_Division}</td>
                  <td>${contract.Contract_Type}</td>
                  <td>${contract.Monthly_Costs}</td>
                  <td>${contract.VAT}</td>
                  <td>${contract.Monthly_Cost_Excl_VAT}</td>
                  <td>${contract.Contract_Term}</td>
                  <td>${contract.Inception_Date || ''}</td>
                  <td>${contract.Termination_Date || ''}</td>
                </tr>
              </tbody>
            </table>`;
                        }
                        document.getElementById("deviceModal").style.display = "block";
                    });
            };
            window.closeDevicesModal = function () {
                document.getElementById("deviceModal").style.display = "none";
            };

            // (Optional helper retained)
            window.showOwnersModal = function (deviceId) {
                fetch(`/devices/${deviceId}/past_owners`)
                    .then(r => r.json())
                    .then(data => {
                        const body = document.getElementById("deviceModalBody");
                        if (!data || data.length === 0) {
                            body.innerHTML = "<p>No previous owners archived for this device.</p>";
                        } else {
                            body.innerHTML = `
            <table border="1" width="100%" cellpadding="5">
              <thead>
                <tr>
                  <th>Name</th><th>Surname</th><th>Personnel #</th><th>Company</th><th>Client Division</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(p => `
                  <tr>
                    <td>${p.Name_}</td>
                    <td>${p.Surname_}</td>
                    <td>${p.Personnel_nr}</td>
                    <td>${p.Company}</td>
                    <td>${p.Client_Division}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>`;
                        }
                        document.getElementById("deviceModal").style.display = "block";
                    })
                    .catch(err => {
                        document.getElementById("deviceModalBody").innerHTML =
                            `<p style="color:#b00020;">Error loading previous owners.</p>`;
                        document.getElementById("deviceModal").style.display = "block";
                        console.error(err);
                    });
            };

            // ------------------------------------
            // Sidebar handle + active link animation + logout confirm (original)
            // ------------------------------------
            const handle = document.getElementById("sidebarHandle");
            function toggleSidebar() {
                const collapsed = document.body.classList.toggle("sidebar-collapsed");
                handle?.setAttribute("aria-pressed", String(!collapsed ? true : false));
                handle?.setAttribute("aria-label", collapsed ? "Expand sidebar" : "Collapse sidebar");
                handle.title = collapsed ? "Expand sidebar" : "Collapse sidebar";
            }
            handle?.addEventListener("click", toggleSidebar);

            const activeLinks = Array.from(document.querySelectorAll(".sidebar a.active"))
                .filter(a => a.id !== "logoutLink");
            activeLinks.forEach(a => a.classList.add("just-activated"));
            setTimeout(() => activeLinks.forEach(a => a.classList.remove("just-activated")), 1050);

            const logoutLink = document.getElementById("logoutLink");
            if (logoutLink) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault();
                    if (confirm("Are you sure you want to log out?")) {
                        window.location.href = this.href;
                    }
                });
            }

            // ------------------------------------
            // Header map for in-place patch (if you skip reload later)
            // ------------------------------------
            const headerIndex = (() => {
                const map = {};
                const ths = table.querySelectorAll("thead th");
                ths.forEach((th, i) => {
                    const labelEl = th.querySelector(".header-label");
                    const label = (labelEl ? labelEl.textContent : th.textContent).trim().toLowerCase();
                    map[label] = i;
                });
                return map;
            })();
            const keyToHeaderLabels = {
                Name_: ["name"],
                Surname_: ["surname"],
                Personnel_nr: ["personnel number", "personnel nr", "personnel no"],
                Company: ["company"],
                Client_Division: ["client division", "division"],
                Device_Name: ["device name", "device"],
                Serial_Number: ["serial number", "serial #", "serial"],
                Device_Description: ["description", "device description"],
                insurance: ["insurance"]
            };
            const norm = s => (s || "").toString().trim().toLowerCase();
            function columnIndexForKey(key) {
                const labels = keyToHeaderLabels[key] || [];
                for (const label of labels) {
                    const idx = headerIndex[norm(label)];
                    if (idx != null) return idx;
                }
                return null;
            }
            function patchActiveRowCells(rowEl, changedObj) {
                if (!rowEl || !changedObj) return;
                for (const [key, val] of Object.entries(changedObj)) {
                    const colIdx = columnIndexForKey(key);
                    if (colIdx != null && rowEl.cells[colIdx]) {
                        rowEl.cells[colIdx].textContent = (val ?? "").toString();
                    }
                }
            }

            // ------------------------------------
            // Left "three-dots" edit rail (non-blocking, fixed position)
            // ------------------------------------
            const rail = document.createElement("div");
            rail.className = "editbtn-rail";
            document.body.appendChild(rail);
            Object.assign(rail.style, {
                position: "fixed",
                width: "30px",
                height: "0px",
                left: "-9999px",
                top: "-9999px",
                pointerEvents: "none", // rail never blocks clicks
                zIndex: "999999"
            });

            const editBtn = document.createElement("button");
            editBtn.className = "editbtn";
            editBtn.type = "button";
            editBtn.setAttribute("aria-label", "Edit row");
            editBtn.innerHTML = `
    <div class="editbtn__dots">
      <span class="editbtn__dot"></span>
      <span class="editbtn__dot"></span>
      <span class="editbtn__dot"></span>
    </div>`;
            rail.appendChild(editBtn);
            Object.assign(editBtn.style, {
                position: "absolute",
                left: "0",
                top: "0",
                width: "30px",
                height: "0px",
                display: "none",
                pointerEvents: "auto" // only the button is clickable
            });

            const scroller = document.querySelector(".contentInner2") || window;
            let activeRowForBtn = null;
            let hideTimer = null;

            function positionRailForCell() {
                const clipR = (scroller === window)
                    ? document.documentElement.getBoundingClientRect()
                    : scroller.getBoundingClientRect();
                rail.style.left = (clipR.left - 30) + "px"; // always pinned to visible left
                rail.style.top = clipR.top + "px";
                rail.style.height = clipR.height + "px";
            }
            function positionButtonForRow(row) {
                const rowR = row.getBoundingClientRect();
                const clipR = (scroller === window)
                    ? document.documentElement.getBoundingClientRect()
                    : scroller.getBoundingClientRect();
                editBtn.style.top = (rowR.top - clipR.top) + "px";
                editBtn.style.height = rowR.height + "px";
            }
            function showForRow(row) {
                clearTimeout(hideTimer);
                activeRowForBtn = row;
                positionRailForCell();
                positionButtonForRow(row);
                editBtn.style.display = "flex";
                editBtn.classList.remove("editbtn--visible");
                requestAnimationFrame(() => editBtn.classList.add("editbtn--visible"));
            }
            function hideIfAllowed() {
                if (!activeRowForBtn) return;
                const overRow = activeRowForBtn.matches(":hover");
                const overBtn = editBtn.matches(":hover");
                if (!overRow && !overBtn) {
                    editBtn.style.display = "none";
                    editBtn.classList.remove("editbtn--visible");
                    activeRowForBtn = null;
                }
            }
            function relayoutRail() {
                if (activeRowForBtn) {
                    positionRailForCell();
                    positionButtonForRow(activeRowForBtn);
                } else {
                    // keep rail pinned even when hidden
                    positionRailForCell();
                }
            }

            // Bind to tbody rows
            rows.forEach(row => {
                row.addEventListener("pointerenter", () => showForRow(row));
                row.addEventListener("pointerleave", (e) => {
                    if (e.relatedTarget && (e.relatedTarget === editBtn || editBtn.contains(e.relatedTarget))) return;
                    clearTimeout(hideTimer);
                    hideTimer = setTimeout(hideIfAllowed, 140);
                });
            });
            editBtn.addEventListener("pointerenter", () => clearTimeout(hideTimer));
            editBtn.addEventListener("pointerleave", (e) => {
                if (activeRowForBtn && e.relatedTarget && (e.relatedTarget === activeRowForBtn || activeRowForBtn.contains(e.relatedTarget))) return;
                clearTimeout(hideTimer);
                hideTimer = setTimeout(hideIfAllowed, 100);
            });
            (scroller === window ? window : scroller).addEventListener("scroll", relayoutRail, { passive: true });
            window.addEventListener("resize", relayoutRail);
            relayoutRail(); // initial

            // ------------------------------------
            // Edit modal plumbing (GET/PUT)
            // ------------------------------------
            const editModal = document.getElementById("editRowModal");
            const editBody = document.getElementById("editRowBody");
            const submitWrap = document.getElementById("editSubmitWrap");
            const submitBtn2 = document.getElementById("submitChangesBtn");

            let pending = {};
            let deviceData = {};
            let currentDeviceId = null;

            function getActiveRowFromButton() {
                // Prefer the hovered row
                const hovered = table.querySelector("tbody tr:hover");
                if (hovered) return hovered;
                // Fallback: closest by vertical center
                const btnRect = editBtn.getBoundingClientRect();
                let best = null, bestDist = Infinity;
                for (const r of rows) {
                    const rr = r.getBoundingClientRect();
                    const center = rr.top + rr.height / 2;
                    const dist = Math.abs(center - (btnRect.top + btnRect.height / 2));
                    if (dist < bestDist) { bestDist = dist; best = r; }
                }
                return best;
            }

            function showEditModal() { if (editModal) editModal.style.display = "block"; }
            window.closeEditRowModal = function () { if (editModal) editModal.style.display = "none"; }

            function openEditRowModal(rowEl) {
                pending = {};
                submitWrap.style.display = "none";
                editBody.innerHTML = "Loading…";

                const id = rowEl?.dataset?.deviceId;
                currentDeviceId = id || null;

                if (!id) { editBody.textContent = "No device id found on row."; showEditModal(); return; }

                fetch(`/api/devices/${id}`)
                    .then(r => { if (!r.ok) throw new Error("Failed to load device"); return r.json(); })
                    .then(data => { deviceData = data; renderEditTable(data); showEditModal(); })
                    .catch(err => { editBody.textContent = err.message || "Error loading device."; showEditModal(); });
            }

            function renderEditTable(data) {
                const fields = [
                    ["Name_", "Name"],
                    ["Surname_", "Surname"],
                    ["Personnel_nr", "Personnel Number"],
                    ["Company", "Company"],
                    ["Client_Division", "Client Division"],
                    ["Device_Name", "Device Name"],
                    ["Serial_Number", "Serial Number"],
                    ["Device_Description", "Description"],
                    ["insurance", "Insurance"]
                ];

                const editTable = document.createElement("table");
                editTable.className = "editgrid";
                editTable.innerHTML = `
    <thead>
      <tr>
        <th>Field</th>
        <th>Current Value</th>
        <th></th>
        <th>New Value</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
                const tBody = editTable.querySelector("tbody");

                fields.forEach(([key, label]) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
      <td class="field-col">${label}</td>
      <td class="value-col">
        <div class="pill">${(data[key] ?? "").toString()}</div>
      </td>
      <td class="edit-col">
        <button type="button" class="confirm edit-row-btn" data-key="${key}">Edit</button>
      </td>
      <td class="new-col">
        <div class="pill edit-input-wrap" data-key="${key}" style="display:none;">
          <input type="text" class="edit-input" value="">
        </div>
      </td>
    `;
                    tBody.appendChild(tr);
                });

                editBody.innerHTML = "";
                editBody.appendChild(editTable);

                // Delegate clicks to show inputs (bind once)
                if (!editBody._delegationBound) {
                    editBody._delegationBound = true;
                    editBody.addEventListener("click", (e) => {
                        const btn = e.target.closest(".edit-row-btn");
                        if (!btn) return;

                        const key = btn.dataset.key;
                        const wrap = editBody.querySelector(`.edit-input-wrap[data-key="${key}"]`);
                        if (!wrap) return;

                        wrap.style.display = "flex"; // reveal pill with input
                        const input = wrap.querySelector(".edit-input");
                        input.value = (deviceData[key] ?? "");
                        input.focus();

                        if (!input._bound) {
                            input._bound = true;
                            input.addEventListener("input", () => {
                                const current = (deviceData[key] ?? "").toString();
                                const next = input.value;
                                if (next !== current) pending[key] = next;
                                else delete pending[key];
                                submitWrap.style.display = Object.keys(pending).length ? "block" : "none";
                            });
                        }
                    });
                }


                submitBtn2.onclick = async () => {
                    if (!currentDeviceId) return;
                    if (!Object.keys(pending).length) {
                        closeEditRowModal();
                        return;
                    }

                    submitBtn2.disabled = true;
                    try {
                        // ⬇️ Queue the edit request for admin approval (NOT a direct PUT anymore)
                        const resp = await fetch(`/api/edit-requests`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                device_id: Number(currentDeviceId),
                                changes: pending
                            })
                        });

                        if (!resp.ok) throw new Error("Failed to queue edit request");
                        const res = await resp.json();

                        if (res.queued || res.created) {
                            alert("Edit request submitted for approval.");
                            closeEditRowModal();
                            // optional: refresh the page so the row clears any local UI state
                            // location.reload();
                        } else {
                            alert(res.message || "Could not queue request.");
                            closeEditRowModal();
                        }
                    } catch (err) {
                        alert(err?.message || "Failed to queue edit request.");
                    } finally {
                        submitBtn2.disabled = false;
                    }
                };



            }


            // Open modal when clicking the floating button
            editBtn.addEventListener("click", () => {
                const row = getActiveRowFromButton();
                if (!row) return;
                openEditRowModal(row);
            });

            // Close on backdrop click
            editModal?.addEventListener("click", (e) => {
                if (e.target === editModal) closeEditRowModal();
            });
        });
    </script>




</body>


</html>