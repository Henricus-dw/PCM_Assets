<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">

</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<body>
    <div class="sidebar">
        <img src="/static/pcm-lockup-goldc-final.svg" alt="PCM logo" />

        <!-- Top navigation -->
        <div class="nav-top">
            <a href="/dashboard" class="{{ 'active' if section == 'home' else '' }}"><span>Home</span></a>
            <a href="/form" class="{{ 'active' if section == 'form' else '' }}"><span>Capturing Form</span></a>

            <a href="/dashboard/vodacom" class="{{ 'active' if section == 'vodacom' else '' }}"><span>Vodacom
                    Dashboard</span></a>
            <a href="/dashboard/devices" class="{{ 'active' if section == 'devices' else '' }}"><span>Devices
                    Dashboard</span></a>
        </div>

        <!-- Bottom navigation -->
        <!-- Bottom navigation -->
        <div class="nav-bottom">
            <a href="/admin" class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            <a href="/settings" class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>

        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">⟨</span> </button>
    </div>


    <!-- Main content -->
    <div class="content3">

        <div class="boxTopHeader2">Devices Dashboard</div>

    </div>
    <div class="sort-overlay">
        <label for="sortSelect">Sort by:</label>
        <select id="sort-select">
            <option value="">Latest Entry</option>
            <option value="inception_date">Inception Date</option>
            <option value="termination_date">Termination Date</option>
            <option value="monthly_costs">Monthly Costs</option>
        </select>
    </div>
    <div class="sort-overlay2"><label>Export:</label>
        <button id="export-btn" class="export-button">
            <img src="/static/excel-document.svg" alt="Excel" class="excel-icon">
        </button>
        <button id="export-pdf-btn">
            <img src="/static/download.svg" alt="PDF Icon" class="pdf-icon">

        </button>

    </div>
    <div class="content2">
        <div class="contentInner2">
            {% if devices %}
            <div class="table-mask"></div>
            <table class="sticky">
                <thead>
                    <tr class="header-row">
                        <th data-col="0">
                            <div class="header-label">Name</div><br>
                            <input type="text" class="header-filter" data-col="0" style="display:none;" />
                            <button class="filter-toggle" data-col="0" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="1">
                            <div class="header-label">Surname</div><br>
                            <input type="text" class="header-filter" data-col="1" style="display:none;" />
                            <button class="filter-toggle" data-col="1" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="2">
                            <div class="header-label">Personnel Number</div><br>
                            <input type="text" class="header-filter" data-col="2" style="display:none;" />
                            <button class="filter-toggle" data-col="2" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="3">
                            <div class="header-label">Company</div><br>
                            <input type="text" class="header-filter" data-col="3" style="display:none;" />
                            <button class="filter-toggle" data-col="3" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="4">
                            <div class="header-label">Client Division</div><br>
                            <input type="text" class="header-filter" data-col="4" style="display:none;" />
                            <button class="filter-toggle" data-col="4" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="5">
                            <div class="header-label">Vodacom Contract</div><br>
                            <input type="text" class="header-filter" data-col="5" style="display:none;" />
                            <button class="filter-toggle" data-col="5" aria-label="Search">⌕</button>
                        </th>

                        <th data-col="6">
                            <div class="header-label">Device Name</div><br>
                            <input type="text" class="header-filter" data-col="6" style="display:none;" />
                            <button class="filter-toggle" data-col="6" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="7">
                            <div class="header-label">Serial Number</div><br>
                            <input type="text" class="header-filter" data-col="7" style="display:none;" />
                            <button class="filter-toggle" data-col="7" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="8">
                            <div class="header-label">Description</div><br>
                            <input type="text" class="header-filter" data-col="8" style="display:none;" />
                            <button class="filter-toggle" data-col="8" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="9">
                            <div class="header-label">Insurance</div><br>
                            <input type="text" class="header-filter" data-col="9" style="display:none;" />
                            <button class="filter-toggle" data-col="9" aria-label="Search"> ⌕ </button>
                        </th>
                        <th data-col="10">
                            <div class="header-label">Past Device Owners</div><br>
                            <input type="text" class="header-filter" data-col="10" style="display:none;" />
                            <button class="filter-toggle" data-col="10" aria-label="Search"> ⌕ </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr data-device-id="{{ device.id }}">
                        <td>{{ device.Name_ }}</td>
                        <td>{{ device.Surname_ }}</td>
                        <td>{{ device.Personnel_nr }}</td>
                        <td>{{ device.Company }}</td>
                        <td>{{ device.Client_Division }}</td>
                        <td>
                            {% if device.vd_id %}
                            <button class="view-contracts-btn" onclick="showContractsModal('{{ device.id }}')">View
                                Contracts</button>
                            {% else %}
                            No contract linked to this device
                            {% endif %}
                        </td>

                        <td>{{ device.Device_Name }}</td>
                        <td>{{ device.Serial_Number }}</td>
                        <td>{{ device.Device_Description }}</td>
                        <td>{{ device.insurance }}</td>
                        <td>
                            {% if device.past_owners_display %}
                            {{ device.past_owners_display.replace('\n', '<br>') | safe }}
                            {% else %}
                            No past owners
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No devices found.</p>
            {% endif %}
        </div>


    </div>
    <div id="deviceModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeDevicesModal()">&times;</span>
            <h2>Linked Devices</h2>
            <div id="deviceModalBody">
                <!-- device list will go here -->
            </div>
        </div>
    </div>
    <div id="editRowModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:800px;">
            <span class="close" onclick="closeEditRowModal()">&times;</span>
            <h2>Edit Device</h2>
            <div id="editRowBody"></div>
            <div id="editSubmitWrap" style="text-align:center; margin-top:16px; display:none;">
                <button id="submitChangesBtn" class="confirm">Submit Changes</button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            z-index: 999;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            margin: auto;
            width: 60%;
            border-radius: 6px;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>

    <script>

        document.addEventListener("DOMContentLoaded", () => {
            try {
                const saved = JSON.parse(sessionStorage.getItem("devices_restore") || "null");
                if (saved) {
                    // scroll
                    if (saved.scroll?.type === "window") {
                        window.scrollTo(saved.scroll.left || 0, saved.scroll.top || 0);
                    } else {
                        const el = document.querySelector(".contentInner2");
                        if (el) {
                            el.scrollTop = saved.scroll?.top || 0;
                            el.scrollLeft = saved.scroll?.left || 0;
                        } else {
                            // fallback to window if container not found
                            window.scrollTo(saved.scroll.left || 0, saved.scroll.top || 0);
                        }
                    }
                    // highlight the updated row
                    if (saved.highlightId) {
                        const r = document.querySelector(`table.sticky tbody tr[data-device-id="${saved.highlightId}"]`);
                        if (r) {
                            r.classList.add("just-updated");
                            setTimeout(() => r.classList.remove("just-updated"), 2400);
                        }
                    }
                    sessionStorage.removeItem("devices_restore");
                }
            } catch (e) {
                // ignore restore errors quietly
            }
            // ------------------------------------
            // Base elements
            // ------------------------------------
            const table = document.querySelector("table.sticky");
            if (!table) return;

            // Your scroll container (adjust if different)
            const scroller = document.querySelector(".contentInner2") || window;

            // ------------------------------------
            // Header map (for in-place patch after save)
            // ------------------------------------
            const headerIndex = (() => {
                const map = {};
                const ths = table.querySelectorAll("thead th");
                ths.forEach((th, i) => {
                    // Your headers often wrap text in .header-label; fallback to th text
                    const labelEl = th.querySelector(".header-label");
                    const label = (labelEl ? labelEl.textContent : th.textContent).trim().toLowerCase();
                    map[label] = i;
                });
                return map;
            })();

            function norm(s) { return (s || "").toString().trim().toLowerCase(); }

            const keyToHeaderLabels = {
                Name_: ["name"],
                Surname_: ["surname"],
                Personnel_nr: ["personnel number", "personnel nr", "personnel no"],
                Company: ["company"],
                Client_Division: ["client division", "division"],
                Device_Name: ["device name", "device"],
                Serial_Number: ["serial number", "serial #", "serial"],
                Device_Description: ["description", "device description"],
                insurance: ["insurance"]
            };

            function columnIndexForKey(key) {
                const labels = keyToHeaderLabels[key] || [];
                for (const label of labels) {
                    const idx = headerIndex[norm(label)];
                    if (idx != null) return idx;
                }
                return null;
            }

            function patchActiveRowCells(rowEl, changedObj) {
                if (!rowEl || !changedObj) return;
                for (const [key, val] of Object.entries(changedObj)) {
                    const colIdx = columnIndexForKey(key);
                    if (colIdx != null && rowEl.cells[colIdx]) {
                        rowEl.cells[colIdx].textContent = (val ?? "").toString();
                    }
                }
            }

            // ------------------------------------
            // Floating rail + button (outside overflow)
            // ------------------------------------
            const rail = document.createElement("div");
            rail.className = "editbtn-rail";
            document.body.appendChild(rail);

            const editBtn = document.createElement("button");
            editBtn.className = "editbtn";
            editBtn.type = "button";
            editBtn.setAttribute("aria-label", "Edit row");
            editBtn.innerHTML = `
    <div class="editbtn__dots">
      <span class="editbtn__dot"></span>
      <span class="editbtn__dot"></span>
      <span class="editbtn__dot"></span>
    </div>`;
            rail.appendChild(editBtn);

            let activeRow = null;
            let hideTimer = null;

            function rect(el) { return el.getBoundingClientRect(); }

            function positionRailForCell(firstCell) {
                const clipR = (scroller === window)
                    ? document.documentElement.getBoundingClientRect()
                    : scroller.getBoundingClientRect();

                if (scroller !== window) {
                    rail.style.position = "fixed";
                    rail.style.left = (clipR.left - 30) + "px";
                    rail.style.top = clipR.top + "px";
                    rail.style.height = clipR.height + "px";
                } else {
                    const cellR = firstCell.getBoundingClientRect();
                    rail.style.position = "absolute";
                    rail.style.left = (cellR.left + window.scrollX - 30) + "px";
                    rail.style.top = (clipR.top + window.scrollY) + "px";
                    rail.style.height = clipR.height + "px";
                }
            }

            function positionButtonForRow(row) {
                const rowR = row.getBoundingClientRect();
                const clipR = (scroller === window)
                    ? document.documentElement.getBoundingClientRect()
                    : scroller.getBoundingClientRect();
                editBtn.style.top = (rowR.top - clipR.top) + "px"; // relative to rail top
                editBtn.style.height = rowR.height + "px";
            }


            function showForRow(row) {
                const firstCell = row.cells[0];
                if (!firstCell) return;
                clearTimeout(hideTimer);
                activeRow = row;
                positionRailForCell(firstCell);
                positionButtonForRow(row);
                editBtn.style.display = "flex";
                editBtn.classList.remove("editbtn--visible");
                requestAnimationFrame(() => editBtn.classList.add("editbtn--visible"));
            }

            function hideIfAllowed() {
                if (!activeRow) return;
                const overRow = activeRow.matches(":hover");
                const overBtn = editBtn.matches(":hover");
                if (!overRow && !overBtn) {
                    editBtn.style.display = "none";
                    editBtn.classList.remove("editbtn--visible");
                    activeRow = null;
                }
            }

            function relayout() {
                if (!activeRow) return;
                positionRailForCell(activeRow.cells[0]);
                positionButtonForRow(activeRow);
            }

            // Bind to tbody rows (exclude header)
            const bodyRows = table.tBodies[0] ? Array.from(table.tBodies[0].rows) : [];
            bodyRows.forEach(row => {
                row.addEventListener("pointerenter", () => showForRow(row));
                row.addEventListener("pointerleave", (e) => {
                    if (e.relatedTarget && (e.relatedTarget === editBtn || editBtn.contains(e.relatedTarget))) return;
                    clearTimeout(hideTimer);
                    hideTimer = setTimeout(hideIfAllowed, 140);
                });
            });

            editBtn.addEventListener("pointerenter", () => clearTimeout(hideTimer));
            editBtn.addEventListener("pointerleave", (e) => {
                if (activeRow && e.relatedTarget && (e.relatedTarget === activeRow || activeRow.contains(e.relatedTarget))) return;
                clearTimeout(hideTimer);
                hideTimer = setTimeout(hideIfAllowed, 100);
            });

            (scroller === window ? window : scroller).addEventListener("scroll", relayout, { passive: true });
            window.addEventListener("resize", relayout);

            // ------------------------------------
            // Modal + backend wiring
            // ------------------------------------
            const editModal = document.getElementById("editRowModal");
            const editBody = document.getElementById("editRowBody");
            const submitWrap = document.getElementById("editSubmitWrap");
            const submitBtn = document.getElementById("submitChangesBtn");

            let pending = {};
            let deviceData = {};
            let currentDeviceId = null;

            function getActiveRowFromButton() {
                const rows = document.querySelectorAll("table.sticky tbody tr");
                for (const r of rows) if (r.matches(":hover")) return r;
                // fallback: nearest center match
                const btnRect = editBtn.getBoundingClientRect();
                let best = null, bestDist = Infinity;
                for (const r of rows) {
                    const rr = r.getBoundingClientRect();
                    const center = rr.top + rr.height / 2;
                    const dist = Math.abs(center - (btnRect.top + btnRect.height / 2));
                    if (dist < bestDist) { bestDist = dist; best = r; }
                }
                return best;
            }

            function showModal() { if (editModal) editModal.style.display = "block"; }
            window.closeEditRowModal = function () { if (editModal) editModal.style.display = "none"; }

            function openEditRowModal(rowEl) {
                pending = {};
                submitWrap.style.display = "none";
                editBody.innerHTML = "Loading…";

                const id = rowEl?.dataset?.deviceId;
                currentDeviceId = id || null;

                if (!id) { editBody.textContent = "No device id found on row."; showModal(); return; }

                fetch(`/api/devices/${id}`)
                    .then(r => { if (!r.ok) throw new Error("Failed to load device"); return r.json(); })
                    .then(data => { deviceData = data; renderEditTable(data); showModal(); })
                    .catch(err => { editBody.textContent = err.message || "Error loading device."; showModal(); });
            }

            function renderEditTable(data) {
                const fields = [
                    ["Name_", "Name"],
                    ["Surname_", "Surname"],
                    ["Personnel_nr", "Personnel Number"],
                    ["Company", "Company"],
                    ["Client_Division", "Client Division"],
                    ["Device_Name", "Device Name"],
                    ["Serial_Number", "Serial Number"],
                    ["Device_Description", "Description"],
                    ["insurance", "Insurance"]
                ];

                const editTable = document.createElement("table");
                editTable.style.width = "100%";
                editTable.style.borderCollapse = "collapse";
                editTable.innerHTML = `
      <thead>
        <tr>
          <th style="text-align:left; padding:8px;">Field</th>
          <th style="text-align:left; padding:8px;">Current Value</th>
          <th style="text-align:left; padding:8px;">&nbsp;</th>
          <th style="text-align:left; padding:8px;">New Value</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
                const tbody = editTable.querySelector("tbody");

                fields.forEach(([key, label]) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
        <td style="padding:8px; vertical-align:top; font-weight:600;">${label}</td>
        <td style="padding:8px; vertical-align:top;">${(data[key] ?? "").toString()}</td>
        <td style="padding:8px; vertical-align:top;">
          <button type="button" class="confirm edit-row-btn" data-key="${key}" style="max-width:160px;">Edit</button>
        </td>
        <td style="padding:8px; vertical-align:top;">
          <div class="edit-input-wrap" data-key="${key}" style="display:none;">
            <input type="text" class="edit-input" style="max-width:320px;" value="">
          </div>
        </td>
      `;
                    tbody.appendChild(tr);
                });

                editBody.innerHTML = "";
                editBody.appendChild(editTable);

                // Delegate clicks for any ".edit-row-btn" (bind once)
                if (!editBody._delegationBound) {
                    editBody._delegationBound = true;
                    editBody.addEventListener("click", (e) => {
                        const btn = e.target.closest(".edit-row-btn");
                        if (!btn) return;

                        const key = btn.dataset.key;
                        const wrap = editBody.querySelector(`.edit-input-wrap[data-key="${key}"]`);
                        if (!wrap) return;

                        wrap.style.display = "block";
                        const input = wrap.querySelector(".edit-input");
                        input.value = (deviceData[key] ?? "");
                        input.focus();

                        if (!input._bound) {
                            input._bound = true;
                            input.addEventListener("input", () => {
                                const current = (deviceData[key] ?? "").toString();
                                const next = input.value;
                                if (next !== current) { pending[key] = next; }
                                else { delete pending[key]; }
                                submitWrap.style.display = Object.keys(pending).length ? "block" : "none";
                            });
                        }
                    });
                }

                // Submit handler (set/replace each render so it uses latest pending/deviceData)
                submitBtn.onclick = async () => {
                    // Need a target row and at least one changed field
                    if (!currentDeviceId) return;
                    if (!Object.keys(pending).length) {
                        if (typeof closeEditRowModal === "function") closeEditRowModal();
                        return;
                    }

                    submitBtn.disabled = true;
                    try {
                        const resp = await fetch(`/api/devices/${currentDeviceId}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(pending)
                        });
                        if (!resp.ok) throw new Error("Failed to update device");
                        const res = await resp.json();

                        if (res.updated) {
                            // Save scroll position (either inside .contentInner2 or window) and the row to highlight
                            const container = document.querySelector(".contentInner2");
                            const scrollState = container
                                ? { type: "element", top: container.scrollTop, left: container.scrollLeft }
                                : { type: "window", top: window.scrollY, left: window.scrollX };

                            sessionStorage.setItem("devices_restore", JSON.stringify({
                                scroll: scrollState,
                                highlightId: String(currentDeviceId)
                            }));

                            // Reload so the dashboard reflects the DB write without losing position
                            location.reload();
                            return; // stop execution after triggering reload
                        } else {
                            alert(res.message || "No changes were applied.");
                            if (typeof closeEditRowModal === "function") closeEditRowModal();
                        }
                    } catch (err) {
                        alert(err?.message || "Failed to update device.");
                    } finally {
                        submitBtn.disabled = false;
                    }
                };

            }

            // Open modal when clicking the floating edit button
            editBtn.addEventListener("click", () => {
                const row = getActiveRowFromButton();
                if (!row) return;
                activeRow = row; // needed for post-save patch
                openEditRowModal(row);
            });

            // Close on backdrop click
            editModal?.addEventListener("click", (e) => {
                if (e.target === editModal) closeEditRowModal();
            });
        });
    </script>


</body>


</html>