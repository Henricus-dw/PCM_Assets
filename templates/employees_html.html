<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Employees</title>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">
</head>

<body class="home-dashboard">
    <div class="sidebar">
        <img src="/static/pcm-lockup-goldc-final.svg" alt="PCM logo" />
        <div class="nav-top">
            <a href="/time-attendance"
                class="{{ 'active' if section == 'time-attendance' else '' }}"><span>Employees</span></a>
            <a href="/biometric-dashboard"
                class="{{ 'active' if section == 'biometric-dashboard' else '' }}"><span>Biometric Dashboard</span></a>
        </div>
        <div class="sidebar-mid">
            <a href="/" class="sidebar-return" title="Return">↺ Return</a>
        </div>
        <div class="nav-bottom">
            {% if request.session.get('is_admin') %}
            <a href="/admin?module=biometric"
                class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            {% endif %}

            <a href="/settings?module=biometric"
                class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>
        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">⟨</span> </button>
    </div>

    <div class="content4">
        <div class="contentInner4">
            <div class="dash-grid">
                <!-- Summary Row -->
                <section class="card">
                    <header class="card-head">
                        <h2>Today Summary</h2>
                    </header>
                    <div class="kpi-grid">
                        <div class="kpi">
                            <div class="kpi-label">Total Employees</div>
                            <div class="kpi-value" id="kpiTotal">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Active Today</div>
                            <div class="kpi-value" id="kpiActive">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Open Sessions</div>
                            <div class="kpi-value" id="kpiOpen">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Late Arrivals</div>
                            <div class="kpi-value" id="kpiLate">-</div>
                        </div>
                    </div>
                </section>

                <section class="card card--tall">
                    <header class="card-head">
                        <h2>Employees</h2>
                        <button class="btn-add" onclick="openEmployeeModal()">+ Add Employee</button>
                        <button class="btn-add" style="background:#10b981;margin-left:8px;"
                            onclick="openPushModal()">Push to Device</button>
                    </header>
                    <div class="table-wrap">
                        <table class="small-table" id="employeeTable">
                            <thead>
                                <tr>
                                    <th>PIN</th>
                                    <th>Name</th>
                                    <th>Surname</th>
                                    <th>Last Event</th>
                                    <th>Last Check-in</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeeBody">
                                <tr>
                                    <td colspan="7" class="muted">Loading employees...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Right panel: Selected employee -->
                <section class="card card--tall" id="employeeDetail">
                    <header class="card-head">
                        <h2>Employee Details</h2>
                        <span class="pill" id="detailStatus">-</span>
                    </header>
                    <div style="padding: 16px;">
                        <div class="muted" id="detailName">Select an employee</div>
                        <div style="margin-top: 10px;">
                            <strong>Today Session</strong>
                            <div id="detailSession" class="muted" style="margin-top:6px;">-</div>
                        </div>
                        <div style="margin-top: 16px;">
                            <strong>Recent Events</strong>
                            <div id="detailEvents" class="muted" style="margin-top:6px;">-</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="employeeModal" style="display: none;">
        <div
            style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
                <h2 style="margin-top: 0;">Add Employee</h2>
                <form id="employeeForm">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Employee ID</label>
                        <input type="text" id="empId" placeholder="e.g. pcm123" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Name</label>
                            <input type="text" id="empName" placeholder="First name" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Surname</label>
                            <input type="text" id="empSurname" placeholder="Surname" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Department</label>
                        <input type="text" id="empDept" placeholder="Department"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Company</label>
                        <select id="empCompany" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                            <option>PCM</option>
                            <option>PROFESSIONAL RISK & ASSET MANAGEMENT</option>
                            <option>PAS/PAC</option>
                            <option>INT</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" onclick="closeEmployeeModal()"
                            style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: white;">Cancel</button>
                        <button type="submit"
                            style="padding: 10px 20px; background: #4b5e70; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Push to Device Modal -->
    <div id="pushModal" style="display: none;">
        <div
            style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 12px; padding: 20px; max-width: 520px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
                <h2 style="margin-top: 0;">Push Employees To Device</h2>
                <p style="color:#6b7280;">Enter the full device URL where employee JSON should be POSTed (e.g.
                    http://192.168.1.10:80/api/employees)</p>
                <div style="margin-bottom:12px;">
                    <input id="deviceUrl" placeholder="http://DEVICE_IP:PORT/path"
                        style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" onclick="closePushModal()"
                        style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: white;">Cancel</button>
                    <button id="pushButton" type="button" onclick="pushToDevice()"
                        style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">Push</button>
                </div>
                <div id="pushResult" style="margin-top:12px; color:#6b7280;"></div>
            </div>
        </div>
    </div>

    <style>
        .btn-add {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-add:hover {
            background: #1e40af;
        }

        .device-status {
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .status-pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .status-in {
            background: #dcfce7;
            color: #166534;
        }

        .status-out {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>

    <script>
        function openEmployeeModal() { document.getElementById('employeeModal').style.display = 'block'; }
        function closeEmployeeModal() { document.getElementById('employeeModal').style.display = 'none'; }

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        async function fetchEmployees() {
            const res = await fetch('/api/employees/summary');
            if (!res.ok) return;
            const data = await res.json();
            const summary = data.totals || {};
            const rows = data.rows || [];
            const tbody = document.getElementById('employeeBody');
            document.getElementById('kpiTotal').innerText = summary.employees ?? '-';
            document.getElementById('kpiActive').innerText = summary.active_today ?? '-';
            document.getElementById('kpiOpen').innerText = summary.open_sessions ?? '-';
            document.getElementById('kpiLate').innerText = summary.late_arrivals ?? '-';

            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="muted">No employees found</td></tr>';
                return;
            }
            tbody.innerHTML = rows.map(e => {
                const statusClass = e.current_status === 'IN' ? 'status-in' : 'status-out';
                return `
                <tr>
                    <td>${e.PIN ?? ''}</td>
                    <td>${e.Name_ || ''}</td>
                    <td>${e.Surname_ || ''}</td>
                    <td>${formatTime(e.last_event)}</td>
                    <td>${formatTime(e.last_check_in)}</td>
                    <td><span class="status-pill ${statusClass}">${e.current_status}</span></td>
                    <td><button onclick="viewEmployee('${e.PIN}', '${e.Name_ || ''}', '${e.Surname_ || ''}', '${e.current_status || ''}')">View history</button></td>
                </tr>
            `;
            }).join('');
        }

        async function viewEmployee(pin, name, surname, status) {
            document.getElementById('detailName').innerText = `${name} ${surname} (PIN ${pin})`;
            document.getElementById('detailStatus').innerText = status || '-';

            const eventsRes = await fetch(`/api/employees/${pin}/events?limit=10`);
            if (eventsRes.ok) {
                const events = await eventsRes.json();
                if (!events.length) {
                    document.getElementById('detailEvents').innerText = 'No events yet';
                } else {
                    document.getElementById('detailEvents').innerHTML = events.map(e => {
                        const action = e.status === 0 ? 'check in' : e.status === 1 ? 'check out' : 'unknown';
                        return `<div>${formatTime(e.timestamp)} — ${action}</div>`;
                    }).join('');
                }
            }

            const today = new Date().toISOString().slice(0, 10);
            const sessionRes = await fetch(`/api/employees/${pin}/session?date_str=${today}`);
            if (sessionRes.ok) {
                const sessions = await sessionRes.json();
                if (!sessions.length) {
                    document.getElementById('detailSession').innerText = 'No session today';
                } else {
                    const s = sessions[0];
                    const duration = s.duration_minutes ? `${s.duration_minutes} mins` : '-';
                    document.getElementById('detailSession').innerText = `Check-in: ${formatTime(s.check_in)} | Check-out: ${formatTime(s.check_out)} | ${duration}`;
                }
            }
        }

        async function deleteEmployee(id) {
            if (!confirm('Delete employee ' + id + '?')) return;
            const res = await fetch('/api.employees/' + encodeURIComponent(id), { method: 'DELETE' });
            if (res.ok) fetchEmployees(); else alert('Delete failed');
        }

        document.getElementById('employeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                Employee_id: document.getElementById('empId').value.trim(),
                Name_: document.getElementById('empName').value.trim(),
                Surname_: document.getElementById('empSurname').value.trim(),
                Department: document.getElementById('empDept').value.trim(),
                Company: document.getElementById('empCompany').value
            };
            const res = await fetch('/api/employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (res.ok) {
                closeEmployeeModal();
                fetchEmployees();
            } else {
                const txt = await res.text();
                alert('Failed to save: ' + txt);
            }
        });

        function openPushModal() { document.getElementById('pushModal').style.display = 'block'; document.getElementById('pushResult').innerText = ''; }
        function closePushModal() { document.getElementById('pushModal').style.display = 'none'; }

        async function pushToDevice() {
            const url = document.getElementById('deviceUrl').value.trim();
            if (!url) { alert('Enter device URL'); return; }
            const btn = document.getElementById('pushButton');
            btn.disabled = true;
            document.getElementById('pushResult').innerText = 'Pushing...';
            try {
                const res = await fetch('/api/devices/push_employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ device_url: url }) });
                if (!res.ok) {
                    const txt = await res.text();
                    document.getElementById('pushResult').innerText = 'Failed: ' + txt;
                } else {
                    const j = await res.json();
                    document.getElementById('pushResult').innerText = 'OK — device responded: ' + (j.device_response?.slice(0, 200) || j.device_status_code);
                }
            } catch (err) {
                document.getElementById('pushResult').innerText = 'Error: ' + err;
            } finally { btn.disabled = false; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchEmployees();
            const handle = document.getElementById("sidebarHandle");
            function toggleSidebar() { document.body.classList.toggle("sidebar-collapsed"); handle?.setAttribute("aria-pressed", String(document.body.classList.contains("sidebar-collapsed"))); }
            handle?.addEventListener("click", toggleSidebar);
        });
    </script>
</body>

</html>