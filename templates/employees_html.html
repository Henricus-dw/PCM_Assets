<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Employees</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/static/pcm-lockup-goldc-final.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">
</head>

<body class="home-dashboard">
    <div class="sidebar">
        <img src="/static/pcm-lockup-goldc-final.svg" alt="PCM logo" />
        <div class="nav-top">
            <a href="/time-attendance"
                class="{{ 'active' if section == 'time-attendance' else '' }}"><span>Employees</span></a>
            <a href="/time-attendance-dashboard"
                class="{{ 'active' if section == 'time-attendance-dashboard' else '' }}"><span>Time
                    and Attendance</span></a>
            <a href="/hours-accumulated"
                class="{{ 'active' if section == 'accumulated-hours' else '' }}"><span>Accumulated Hours</span></a>
        </div>
        <div class="sidebar-mid">
            <a href="/" class="sidebar-return" title="Return">↺ Return</a>
        </div>
        <div class="nav-bottom">
            {% if request.session.get('is_admin') %}
            <a href="/admin?module=biometric"
                class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            {% endif %}

            <a href="/settings?module=biometric"
                class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>
        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">⟨</span> </button>
    </div>

    <div class="content4">
        <div class="contentInner4">
            <div class="dash-grid employees-grid">
                <section class="card card--tall employees-card">
                    <header class="card-head">
                        <h2>Employees</h2>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input id="employeeSearch" class="input" placeholder="Search by PIN, name or surname"
                                style="height:32px;" />
                            <button class="btn-add" style="background:#4b5e70;" onclick="openEmployeeModal()">Add
                                Employee</button>
                        </div>
                    </header>
                    <div class="table-wrap">
                        <table class="small-table employees-table" id="employeeTable">
                            <colgroup>
                                <col class="col-pin" />
                                <col class="col-name" />
                                <col class="col-emp" />
                                <col class="col-company" />
                                <col class="col-site" />
                                <col class="col-division" />
                                <col class="col-status" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>PIN</th>
                                    <th>Name &amp; Surname</th>
                                    <th>Employee Nr</th>
                                    <th>Company</th>
                                    <th>Site</th>
                                    <th>Division</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="employeeBody">
                                <tr>
                                    <td colspan="7" class="muted">Loading employees...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Right panel: Selected employee -->
                <section class="card card--tall employee-detail-card" id="employeeDetail">
                    <header class="card-head">
                        <h2>Employee Details</h2>
                        <span class="pill" id="detailStatus">-</span>
                    </header>
                    <div style="padding: 16px;">
                        <div class="muted" id="detailName">Select an employee</div>
                        <div style="margin-top: 10px;">
                            <strong>Today Session</strong>
                            <div id="detailSession" class="muted" style="margin-top:6px;">-</div>
                        </div>
                        <div style="margin-top: 16px;">
                            <strong>Recent Events</strong>
                            <div id="detailEvents" class="muted" style="margin-top:6px;">-</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="employeeModal" style="display: none;">
        <div
            style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
                <h2 style="margin-top: 0;">Add Employee</h2>
                <form id="employeeForm">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Employee ID</label>
                        <input type="text" id="empId" placeholder="e.g. pcm123" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Name</label>
                            <input type="text" id="empName" placeholder="First name" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Surname</label>
                            <input type="text" id="empSurname" placeholder="Surname" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Company</label>
                        <select id="empCompany" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                            <option>Risk</option>
                            <option>International</option>
                            <option>PCM</option>
                            <option>PPS</option>
                            <option>PAC/PAS</option>
                        </select>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Site</label>
                        <select id="empSite" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                            <option>SG Bloem</option>
                            <option>SG PE</option>
                            <option>SG Durban</option>
                            <option>SG George</option>
                            <option>SG Cape Town</option>
                            <option>SG Joburg</option>
                            <option>Vector Linbrow</option>
                            <option>Vector Bloemfontein</option>
                            <option>Vector Roodepoort</option>
                            <option>Vector Polokwane</option>
                            <option>Vector Nelspruit</option>
                            <option>DHL</option>
                            <option>KWE</option>
                            <option>Imperial</option>
                            <option>Bollore</option>
                        </select>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Division</label>
                        <select id="empDivision" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                            <option>VH</option>
                            <option>VA</option>
                            <option>CCTV</option>
                            <option>All the above</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" onclick="closeEmployeeModal()"
                            style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: white;">Cancel</button>
                        <button type="submit"
                            style="padding: 10px 20px; background: #4b5e70; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .btn-add {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-add:hover {
            background: #1e40af;
        }

        .device-status {
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .status-pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .status-in {
            background: #dcfce7;
            color: #166534;
        }

        .status-out {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>

    <script>
        function openEmployeeModal() { document.getElementById('employeeModal').style.display = 'block'; }
        function closeEmployeeModal() { document.getElementById('employeeModal').style.display = 'none'; }

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        let allEmployees = [];

        function updateEmployeeRowTruncation() {
            const rows = document.querySelectorAll('#employeeTable tbody tr');
            rows.forEach(row => {
                row.classList.remove('row-truncated');
                let truncated = false;
                const cells = row.querySelectorAll('td.cell-truncate');
                cells.forEach(cell => {
                    const isTruncated = cell.scrollWidth > cell.clientWidth;
                    cell.classList.toggle('cell-truncated', isTruncated);
                    if (isTruncated) truncated = true;
                });
                if (truncated) row.classList.add('row-truncated');
            });
        }

        function renderEmployees(rows) {
            const tbody = document.getElementById('employeeBody');
            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="muted">No employees found</td></tr>';
                return;
            }
            tbody.innerHTML = rows.map(e => {
                const statusClass = e.current_status === 'IN' ? 'status-in' : 'status-out';
                const pinSafe = String(e.PIN ?? '');
                const nameSafe = String(e.Name_ ?? '').replace(/'/g, "&#39;");
                const surnameSafe = String(e.Surname_ ?? '').replace(/'/g, "&#39;");
                const statusSafe = String(e.current_status ?? '').replace(/'/g, "&#39;");
                return `
                <tr class="employee-row" data-pin="${pinSafe}" onclick="selectEmployeeRow(this); viewEmployee('${pinSafe}', '${nameSafe}', '${surnameSafe}', '${statusSafe}')">
                    <td>${e.PIN ?? ''}</td>
                    <td class="cell-truncate">${(e.Name_ || '')} ${(e.Surname_ || '')}</td>
                    <td class="cell-truncate">${e.Employee_id || ''}</td>
                    <td class="cell-truncate">${e.Company || ''}</td>
                    <td class="cell-truncate">${e.Site || ''}</td>
                    <td class="cell-truncate">${e.Division || ''}</td>
                    <td><span class="status-pill ${statusClass}">${e.current_status}</span></td>
                </tr>
            `;
            }).join('');

            if (selectedPin) {
                const selectedRow = document.querySelector(`#employeeTable tbody tr[data-pin="${selectedPin}"]`);
                if (selectedRow) selectedRow.classList.add('selected');
            }

            requestAnimationFrame(updateEmployeeRowTruncation);
        }

        function applyEmployeeFilter() {
            const q = document.getElementById('employeeSearch').value.trim().toLowerCase();
            if (!q) {
                renderEmployees(allEmployees);
                return;
            }
            const filtered = allEmployees.filter(e => {
                const pin = String(e.PIN ?? '').toLowerCase();
                const name = String(e.Name_ ?? '').toLowerCase();
                const surname = String(e.Surname_ ?? '').toLowerCase();
                const emp = String(e.Employee_id ?? '').toLowerCase();
                const company = String(e.Company ?? '').toLowerCase();
                const site = String(e.Site ?? '').toLowerCase();
                const division = String(e.Division ?? '').toLowerCase();
                return pin.includes(q) || name.includes(q) || surname.includes(q) || emp.includes(q) || company.includes(q) || site.includes(q) || division.includes(q);
            });
            renderEmployees(filtered);
        }

        async function fetchEmployees() {
            const res = await fetch('/api/employees/summary');
            if (!res.ok) return;
            const data = await res.json();
            allEmployees = data.rows || [];
            applyEmployeeFilter();
        }

        async function viewEmployee(pin, name, surname, status) {
            document.getElementById('detailName').innerText = `${name} ${surname} (PIN ${pin})`;
            document.getElementById('detailStatus').innerText = status || '-';

            const eventsRes = await fetch(`/api/employees/${pin}/events?limit=10`);
            if (eventsRes.ok) {
                const events = await eventsRes.json();
                if (!events.length) {
                    document.getElementById('detailEvents').innerText = 'No events yet';
                } else {
                    document.getElementById('detailEvents').innerHTML = events.map(e => {
                        const action = e.status === 0 ? 'check in' : e.status === 1 ? 'check out' : 'unknown';
                        return `<div>${formatTime(e.timestamp)} — ${action}</div>`;
                    }).join('');
                }
            }

            const today = new Date().toISOString().slice(0, 10);
            const sessionRes = await fetch(`/api/employees/${pin}/session?date_str=${today}`);
            if (sessionRes.ok) {
                const sessions = await sessionRes.json();
                if (!sessions.length) {
                    document.getElementById('detailSession').innerText = 'No session today';
                } else {
                    const s = sessions[0];
                    const duration = s.duration_minutes ? `${s.duration_minutes} mins` : '-';
                    document.getElementById('detailSession').innerText = `Check-in: ${formatTime(s.check_in)} | Check-out: ${formatTime(s.check_out)} | ${duration}`;
                }
            }
        }

        let selectedPin = null;

        function selectEmployeeRow(row) {
            document.querySelectorAll('#employeeTable tbody .employee-row.selected').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            selectedPin = row.dataset.pin || null;
            requestAnimationFrame(updateEmployeeRowTruncation);
        }

        async function deleteEmployee(id) {
            if (!confirm('Delete employee ' + id + '?')) return;
            const res = await fetch('/api.employees/' + encodeURIComponent(id), { method: 'DELETE' });
            if (res.ok) fetchEmployees(); else alert('Delete failed');
        }

        document.getElementById('employeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                Employee_id: document.getElementById('empId').value.trim(),
                Name_: document.getElementById('empName').value.trim(),
                Surname_: document.getElementById('empSurname').value.trim(),
                Company: document.getElementById('empCompany').value,
                Site: document.getElementById('empSite').value,
                Division: document.getElementById('empDivision').value
            };
            const res = await fetch('/api/employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (res.ok) {
                closeEmployeeModal();
                fetchEmployees();
            } else {
                const txt = await res.text();
                alert('Failed to save: ' + txt);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchEmployees();
            const searchInput = document.getElementById('employeeSearch');
            searchInput?.addEventListener('input', applyEmployeeFilter);
            setInterval(fetchEmployees, 5000);
            const handle = document.getElementById("sidebarHandle");
            function toggleSidebar() { document.body.classList.toggle("sidebar-collapsed"); handle?.setAttribute("aria-pressed", String(document.body.classList.contains("sidebar-collapsed"))); }
            handle?.addEventListener("click", toggleSidebar);
            window.addEventListener('resize', updateEmployeeRowTruncation);
        });
    </script>
</body>

</html>