<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>PCM Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css?v={{ time }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .confirm {
            width: auto;
            height: auto;
            color: white;
            background-color: #4b5e70;
            border: none;
            border-radius: 14px;
            padding: 4px 14px 6px 14px;
            font: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin: 0 auto;
            margin-top: 20px;
            transition: background-color 0.2s ease;

        }



        .confirm:hover {
            background-color: #f6efe3;

            color: #333;
        }

        .confirm2:hover {
            background-color: #f6efe3;

            color: #333;
        }

        .confirm2 {
            width: auto;
            height: 20px;
            color: white;
            background-color: #4b5e70;
            border: none;
            border-radius: 14px;
            padding: 2px 14px 12px 14px;
            font: inherit;
            cursor: pointer;
            display: block;
            /* no flexbox here */
            margin-left: auto;
            /* pushes it to the right */
            margin-right: 30px;
            font-size: 12px;
            margin-bottom: -20px;
            transition: background-color 0.2s ease;
        }


        /* Confirm buttons reserve their space but start hidden */
        #confirm1,
        #confirm2 {
            visibility: hidden;
        }



        .form_settings {
            height: auto;
            max-height: 200px;
            overflow: hidden;
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
    </style>
</head>

<body class="home-dashboard">
    <!-- Sidebar (220px wide; CSS already handles styling) -->
    <div class="sidebar">
        <img src="/static/pcm-lockup-goldc-final.svg" alt="PCM logo" />

        <!-- Top navigation -->
        <div class="nav-top">
            <a href="/dashboard" class="{{ 'active' if section == 'home' else '' }}"><span>Home</span></a>
            <a href="/form" class="{{ 'active' if section == 'form' else '' }}"><span>Capturing Form</span></a>
            <a href="/dashboard/vodacom" class="{{ 'active' if section == 'vodacom' else '' }}"><span>Vodacom
                    Dashboard</span></a>
            <a href="/dashboard/devices" class="{{ 'active' if section == 'devices' else '' }}"><span>Devices
                    Dashboard</span></a>
        </div>

        <!-- Bottom navigation -->
        <div class="nav-bottom">
            <a href="/admin" class="{{ 'active' if section == 'admin' else '' }}"><span>Admin</span></a>
            <a href="/settings" class="{{ 'active' if section == 'settings' else '' }}"><span>Settings</span></a>
            <a href="/logout" id="logoutLink" class="{{ 'active' if section == 'logout' else '' }}">
                <span>Log Out</span>
            </a>
        </div>
        <button id="sidebarHandle" class="sidebar-handle" aria-label="Collapse sidebar" aria-pressed="false"
            title="Collapse sidebar"> <span class="handle-icon" aria-hidden="true">‚ü®</span> </button>
    </div>

    <div class="content">
        <!-- Block 1: The form -->


        <div class="contentInner" style="max-width: 500px; " id="form1">
            <div class="boxTopHeader">Settings</div>
            <form id="profileForm" method="POST" action="/settings/profile" class="form_settings">
                <button type="button" id="editProfileBtn" class="confirm2">Edit</button>

                <div class="UserDetails">
                    <span class="field-label">Name:</span>
                    <span class="field-control">
                        <input type="text" name="name" value="{{ current_user.name or '' }}" placeholder="(optional)">
                    </span>
                </div>

                <div class="UserDetails">
                    <span class="field-label">Surname:</span>
                    <span class="field-control">
                        <input type="text" name="surname" value="{{ current_user.surname or '' }}"
                            placeholder="(optional)">
                    </span>
                </div>

                <div class="UserDetails">
                    <span class="field-label">Email address:</span>
                    <span class="field-control">
                        <span class="readonly-value">{{ current_user.email }}</span>
                    </span>
                </div>

                <button type="submit" id="confirm1" class="confirm">Confirm</button>
            </form>



            <div class="form_line"></div>

            <form id="passwordForm" method="POST" action="/settings/password" class="form_settings">
                <div class="UserDetails">
                    <span class="field-label">Password:</span>
                    <span class="field-control">
                        <input type="password" name="password" placeholder="Password" required>
                    </span>
                </div>

                <div class="UserDetails">
                    <span class="field-label">New Password:</span>
                    <span class="field-control">
                        <input type="password" name="new_password" placeholder="New Password" minlength="8" required>
                    </span>
                </div>

                <div class="UserDetails">
                    <span class="field-label">Confirm new password:</span>
                    <span class="field-control">
                        <input type="password" name="confirm_password" placeholder="New Password" required>
                    </span>
                </div>

                <button type="submit" id="confirm2" class="confirm">Confirm</button>
            </form>

        </div>


        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- Sidebar toggle ---
                const handle = document.getElementById("sidebarHandle");
                const collapseBtn = document.getElementById("sidebarCollapse");
                const scrim = document.getElementById("sidebarScrim");
                function toggleSidebar() {
                    const collapsed = document.body.classList.toggle("sidebar-collapsed");
                    handle?.setAttribute("aria-pressed", String(!collapsed));
                    handle?.setAttribute("aria-label", collapsed ? "Expand sidebar" : "Collapse sidebar");
                    handle.title = collapsed ? "Expand sidebar" : "Collapse sidebar";
                }
                handle?.addEventListener("click", toggleSidebar);
                collapseBtn?.addEventListener("click", toggleSidebar);
                scrim?.addEventListener("click", () => document.body.classList.remove("sidebar-open"));

                // --- Profile form: show Confirm if NAME or SURNAME changed ---
                const profileForm = document.getElementById('profileForm');
                const nameInput = profileForm?.querySelector('input[name="name"]');
                const surnameInput = profileForm?.querySelector('input[name="surname"]');
                const confirm1 = document.getElementById('confirm1');

                const editBtn = document.getElementById('editProfileBtn');
                if (editBtn && nameInput && surnameInput) {
                    // focus
                    editBtn.addEventListener('click', () => {
                        nameInput.focus();
                        const length = nameInput.value.length;
                        nameInput.setSelectionRange(length, length);
                        // optional highlight toggle
                        [nameInput, surnameInput].forEach(input => {
                            const row = input.closest('.UserDetails');
                            row?.classList.toggle('highlight-input');
                        });
                    });
                }

                if (profileForm && confirm1) {
                    const initialName = (nameInput?.defaultValue ?? '').trim();
                    const initialSurname = (surnameInput?.defaultValue ?? '').trim();
                    function checkProfileChanged() {
                        const nameChanged = !!nameInput && nameInput.value.trim() !== initialName;
                        const surnameChanged = !!surnameInput && surnameInput.value.trim() !== initialSurname;
                        confirm1.style.visibility = (nameChanged || surnameChanged) ? 'visible' : 'hidden';
                    }
                    nameInput?.addEventListener('input', checkProfileChanged);
                    surnameInput?.addEventListener('input', checkProfileChanged);
                    nameInput?.addEventListener('change', checkProfileChanged);
                    surnameInput?.addEventListener('change', checkProfileChanged);
                    checkProfileChanged();
                    setTimeout(checkProfileChanged, 200); // handle autofill
                }

                // --- Password form: show Confirm if any password field has text ---
                const passwordForm = document.getElementById('passwordForm');
                const currPwd = passwordForm?.querySelector('input[name="password"]');
                const newPwd = passwordForm?.querySelector('input[name="new_password"]');
                const confPwd = passwordForm?.querySelector('input[name="confirm_password"]');
                const confirm2 = document.getElementById('confirm2');
                if (passwordForm && confirm2) {
                    function checkPwdTyped() {
                        const anyTyped = (currPwd?.value || newPwd?.value || confPwd?.value || '').length > 0;
                        confirm2.style.visibility = anyTyped ? 'visible' : 'hidden';
                    }
                    [currPwd, newPwd, confPwd].forEach(el => el && el.addEventListener('input', checkPwdTyped));
                    checkPwdTyped();
                }

                // --- Messages + error borders from query params ---
                const params = new URLSearchParams(window.location.search);
                const ok = params.get('ok');   // 'profile' | 'pwd'
                const err = params.get('err'); // 'badpwd' | 'nomatch'
                function showMessageAbove(formElem, text, isError) {
                    if (!formElem) return;
                    const msg = document.createElement('div');
                    msg.textContent = text;
                    msg.style.margin = '10px 30px 0 30px';
                    msg.style.fontSize = '14px';
                    msg.style.fontWeight = '600';
                    msg.style.color = isError ? '#b00020' : '#0a7a3c';
                    formElem.parentElement.insertBefore(msg, formElem);
                }
                function redBorderForInput(input) {
                    const row = input?.closest('.UserDetails');
                    if (row) {
                        row.style.boxShadow = '0 0 0 2px #d9534f inset';
                        row.style.borderRadius = '14px';
                    }
                }
                if (ok === 'profile') showMessageAbove(profileForm, 'Profile details updated successfully', false);
                else if (ok === 'pwd') showMessageAbove(passwordForm, 'Password changed successfully', false);
                if (err === 'badpwd') { showMessageAbove(passwordForm, 'Incorrect password', true); redBorderForInput(currPwd); }
                else if (err === 'nomatch') { showMessageAbove(passwordForm, 'Password does not match', true); redBorderForInput(newPwd); redBorderForInput(confPwd); }
                if (ok || err) {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('ok');
                    url.searchParams.delete('err');
                    window.history.replaceState({}, '', url.toString());
                }

                // --- Logout confirm (now runs because no ReferenceError) ---
                const logoutLink = document.getElementById("logoutLink");
                if (logoutLink) {
                    logoutLink.addEventListener("click", function (e) {
                        e.preventDefault();
                        if (confirm("Are you sure you want to log out?")) {
                            window.location.href = this.href;
                        }
                    });
                }
            });
        </script>






</body>

</html>